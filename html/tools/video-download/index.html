<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è§†é¢‘è§£æå·¥å…· - æ— æ°´å°ä¸‹è½½</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 800px;
            width: 100%;
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            color: white;
            font-size: 28px;
            margin-bottom: 10px;
        }

        .header p {
            color: rgba(255, 255, 255, 0.9);
            font-size: 14px;
        }

        .content {
            padding: 30px;
        }

        .platform-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .platform-tab {
            flex: 1;
            min-width: 120px;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            background: white;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s ease;
            font-size: 14px;
            font-weight: 500;
        }

        .platform-tab:hover {
            border-color: #667eea;
            background: #f5f5ff;
        }

        .platform-tab.active {
            border-color: #667eea;
            background: #667eea;
            color: white;
        }

        .platform-tab .icon {
            font-size: 20px;
            margin-bottom: 5px;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .input-group input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .input-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .input-group input::placeholder {
            color: #999;
        }

        .btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .result-container {
            margin-top: 30px;
            display: none;
        }

        .result-container.show {
            display: block;
        }

        .result-info {
            background: #f5f5ff;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .result-info h3 {
            margin-bottom: 15px;
            color: #333;
        }

        .info-item {
            display: flex;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .info-item label {
            width: 80px;
            color: #666;
            font-weight: 500;
        }

        .info-item span {
            flex: 1;
            color: #333;
            word-break: break-all;
        }

        .preview-container {
            background: #000;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .preview-container video {
            width: 100%;
            display: block;
        }

        .preview-placeholder {
            padding: 100px 20px;
            text-align: center;
            color: #666;
        }

        .download-section {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .download-btn {
            flex: 1;
            min-width: 150px;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .download-btn.primary {
            background: #667eea;
            color: white;
        }

        .download-btn.primary:hover {
            background: #5568d3;
        }

        .download-btn.secondary {
            background: #48bb78;
            color: white;
        }

        .download-btn.secondary:hover {
            background: #38a169;
        }

        .download-btn.tertiary {
            background: #e5e7eb;
            color: #374151;
        }

        .download-btn.tertiary:hover {
            background: #d1d5db;
        }

        .error-message {
            background: #fff5f5;
            border: 2px solid #fc8181;
            color: #c53030;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            display: none;
        }

        .error-message.show {
            display: block;
        }

        .error-message strong {
            display: block;
            margin-bottom: 8px;
            font-size: 16px;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .loading.show {
            display: block;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #e0e0e0;
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading p {
            color: #666;
            font-size: 14px;
        }

        .tips {
            background: #fff7ed;
            border-left: 4px solid #ed8936;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            font-size: 13px;
            color: #666;
        }

        .tips h4 {
            color: #ed8936;
            margin-bottom: 8px;
        }

        .tips ul {
            margin-left: 20px;
        }

        .tips li {
            margin-bottom: 5px;
        }

        @media (max-width: 600px) {
            .platform-tabs {
                flex-direction: column;
            }

            .platform-tab {
                min-width: auto;
            }

            .download-section {
                flex-direction: column;
            }

            .download-btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¬ è§†é¢‘è§£æå·¥å…·</h1>
            <p>æ”¯æŒæŠ–éŸ³ã€å¿«æ‰‹ã€Bç«™æ— æ°´å°è§£æä¸‹è½½</p>
        </div>

        <div class="content">
            <div class="platform-tabs">
                <div class="platform-tab active" data-platform="douyin">
                    <div class="icon">ğŸµ</div>
                    <div>æŠ–éŸ³</div>
                </div>
                <div class="platform-tab" data-platform="kuaishou">
                    <div class="icon">âš¡</div>
                    <div>å¿«æ‰‹</div>
                </div>
                <div class="platform-tab" data-platform="bilibili">
                    <div class="icon">ğŸ“º</div>
                    <div>Bç«™</div>
                </div>
            </div>

            <div class="input-group">
                <label for="video-url">è§†é¢‘é“¾æ¥</label>
                <input type="text" id="video-url" placeholder="è¯·ç²˜è´´è§†é¢‘åˆ†äº«é“¾æ¥...">
            </div>

            <div class="input-group">
                <label for="api-select">é€‰æ‹©APIè§£ææ¥å£</label>
                <select id="api-select" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 14px; background: white; cursor: pointer;">
                    <option value="api1">è¿œæ¢¦API (mmp.cc)</option>
                    <option value="custom">âœï¸ è‡ªå®šä¹‰API</option>
                </select>
            </div>

            <div class="input-group" id="custom-api-group" style="display: none;">
                <label for="custom-api">è‡ªå®šä¹‰APIåœ°å€</label>
                <input type="text" id="custom-api" placeholder="è¾“å…¥APIåœ°å€ï¼Œå¦‚ï¼šhttps://api.example.com/api?url=">
                <div style="margin-top: 5px; font-size: 12px; color: #666;">
                    ğŸ’¡ æç¤ºï¼šè‡ªå®šä¹‰APIéœ€è¦æ”¯æŒJSONPï¼ˆcallbackå‚æ•°ï¼‰æˆ–CORSï¼Œè¿”å›æ ¼å¼ä¸ºJSON
                </div>
            </div>

            <div style="margin-top: 10px; margin-bottom: 20px; font-size: 12px; color: #666;">
                <span id="api-status" style="color: #10b981;">â— APIçŠ¶æ€ï¼šå°±ç»ª</span>
                <button id="test-apis-btn" style="margin-left: 10px; padding: 5px 10px; border: 1px solid #667eea; background: white; color: #667eea; border-radius: 5px; cursor: pointer; font-size: 12px;">æµ‹è¯•API</button>
            </div>

            <button class="btn btn-primary" id="parse-btn">å¼€å§‹è§£æ</button>

            <div class="loading" id="loading">
                <div class="loading-spinner"></div>
                <p>æ­£åœ¨è§£æè§†é¢‘ï¼Œè¯·ç¨å€™...</p>
            </div>

            <div class="error-message" id="error-message">
                <strong>é”™è¯¯æç¤º</strong>
                <p id="error-text"></p>
                <div id="error-details" style="margin-top: 10px; font-size: 12px;"></div>
            </div>

            <div class="result-container" id="result-container">
                <div class="result-info">
                    <h3>ğŸ“‹ è§†é¢‘ä¿¡æ¯</h3>
                    <div class="info-item">
                        <label>æ ‡é¢˜ï¼š</label>
                        <span id="video-title">-</span>
                    </div>
                    <div class="info-item">
                        <label>ä½œè€…ï¼š</label>
                        <span id="video-author">-</span>
                    </div>
                    <div class="info-item">
                        <label>æ—¶é•¿ï¼š</label>
                        <span id="video-duration">-</span>
                    </div>
                </div>

                <div class="preview-container" id="video-preview"></div>

                <div class="download-section">
                    <button class="download-btn primary" id="download-hd">
                        <span>ğŸ“¥</span> é«˜æ¸…ä¸‹è½½
                    </button>
                    <button class="download-btn secondary" id="download-sd">
                        <span>ğŸ“¥</span> æ ‡æ¸…ä¸‹è½½
                    </button>
                    <button class="download-btn tertiary" id="preview-video">
                        <span>ğŸ¬</span> æ–°çª—å£é¢„è§ˆ
                    </button>
                    <button class="download-btn tertiary" id="view-original">
                        <span>ğŸ‘€</span> æŸ¥çœ‹åŸè§†é¢‘
                    </button>
                </div>
            </div>

            <div class="tips">
                <h4>ğŸ’¡ ä½¿ç”¨æç¤º</h4>
                <ul>
                    <li>å¤åˆ¶è§†é¢‘åˆ†äº«é“¾æ¥åç²˜è´´åˆ°è¾“å…¥æ¡†ä¸­</li>
                    <li>æŠ–éŸ³é“¾æ¥ç¤ºä¾‹ï¼šhttps://v.douyin.com/xxx/</li>
                    <li>å¿«æ‰‹é“¾æ¥ç¤ºä¾‹ï¼šhttps://www.kuaishou.com/short-video/xxx</li>
                    <li>Bç«™é“¾æ¥ç¤ºä¾‹ï¼šhttps://www.bilibili.com/video/BVxxx</li>
                    <li>è§£ææˆåŠŸåå¯åœ¨çº¿é¢„è§ˆï¼Œç‚¹å‡»æŒ‰é’®å³å¯ä¸‹è½½æ— æ°´å°è§†é¢‘</li>
                </ul>
                
                <h4>ğŸ”§ APIè¯´æ˜</h4>
                <ul>
                    <li><strong>è¿œæ¢¦APIï¼š</strong>ä½¿ç”¨ mmp.cc å…è´¹APIæ¥å£</li>
                    <li><strong>æ”¯æŒå¹³å°ï¼š</strong>æŠ–éŸ³ã€å¿«æ‰‹ã€Bç«™ç­‰å¤šä¸ªå¹³å°</li>
                    <li><strong>è¿”å›æ ¼å¼ï¼š</strong>JSONæ ¼å¼ï¼ŒåŒ…å«è§†é¢‘URLã€æ ‡é¢˜ã€ä½œè€…ç­‰ä¿¡æ¯</li>
                    <li><strong>è·¨åŸŸå¤„ç†ï¼š</strong>åŒæ—¶æ”¯æŒCORSå’ŒJSONPä¸¤ç§æ–¹å¼</li>
                    <li><strong>è‡ªå®šä¹‰APIï¼š</strong>å¦‚éœ€ä½¿ç”¨å…¶ä»–APIï¼Œå¯è¾“å…¥è‡ªå®šä¹‰åœ°å€ï¼ˆéœ€æ”¯æŒJSONPæˆ–CORSï¼‰</li>
                </ul>

                <h4>ğŸ“‹ APIä¿¡æ¯</h4>
                <div style="background: #f8f9fa; padding: 10px; border-radius: 8px; margin-top: 8px;">
                    <p style="margin: 5px 0;"><strong>API (mmp.cc):</strong> api.mmp.cc/api/Jiexi</p>
                    <p style="margin: 5px 0; color: #666; font-size: 12px;">ğŸ’¡ ç¨³å®šå¯é çš„å…è´¹è§†é¢‘è§£æAPI</p>
                </div>

                <h4>ğŸ”§ å¦‚æœè§£æå¤±è´¥ï¼Œå¯ä»¥å°è¯•</h4>
                <ul>
                    <li><strong>åˆ‡æ¢APIï¼š</strong>å°è¯•ä½¿ç”¨è‡ªå®šä¹‰API</li>
                    <li><strong>æŠ–éŸ³ï¼š</strong>è®¿é—® <a href="https://www.douyin.com" target="_blank" style="color: #667eea;">æŠ–éŸ³å®˜ç½‘</a> æˆ–ä½¿ç”¨ä¸“ä¸šä¸‹è½½å·¥å…·</li>
                    <li><strong>å¿«æ‰‹ï¼š</strong>è®¿é—® <a href="https://www.kuaishou.com" target="_blank" style="color: #667eea;">å¿«æ‰‹å®˜ç½‘</a> æˆ–ä½¿ç”¨ä¸“ä¸šä¸‹è½½å·¥å…·</li>
                    <li><strong>Bç«™ï¼š</strong>è®¿é—® <a href="https://www.bilibili.com" target="_blank" style="color: #667eea;">Bç«™å®˜ç½‘</a> ä½¿ç”¨å®˜æ–¹ä¸‹è½½åŠŸèƒ½</li>
                    <li><strong>å…¶ä»–æ–¹æ¡ˆï¼š</strong>å°è¯• <a href="https://www.bilibili.com/video/BV1..." target="_blank" style="color: #667eea;">bilibili-evolved</a> æµè§ˆå™¨æ’ä»¶</li>
                </ul>
                <h4>âš ï¸ æ³¨æ„äº‹é¡¹</h4>
                <ul>
                    <li>APIæ¥å£å¯èƒ½å¤±æ•ˆï¼Œè¯·å®šæœŸæ›´æ–°</li>
                    <li>éƒ¨åˆ†è§†é¢‘å¯èƒ½å› ç‰ˆæƒåŸå› æ— æ³•ä¸‹è½½</li>
                    <li>è¯·å°Šé‡åˆ›ä½œè€…ç‰ˆæƒï¼Œä»…ä¾›ä¸ªäººå­¦ä¹ ä½¿ç”¨</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        // å¹³å°é€‰æ‹©
        const platformTabs = document.querySelectorAll('.platform-tab');
        let currentPlatform = 'douyin';

        // ç»Ÿä¸€çš„å†…ç½®APIåˆ—è¡¨ï¼Œæµ‹è¯•å’Œè§£æå…±ç”¨
        const builtInApis = [
            {
                name: 'è¿œæ¢¦API (mmp.cc)',
                url: 'https://api.mmp.cc/api/Jiexi?url=',
                type: 'json'
            }
        ];

        platformTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                platformTabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                currentPlatform = tab.dataset.platform;
                updatePlaceholder();
            });
        });

        function updatePlaceholder() {
            const input = document.getElementById('video-url');
            const placeholders = {
                douyin: 'è¯·ç²˜è´´æŠ–éŸ³è§†é¢‘åˆ†äº«é“¾æ¥ï¼Œå¦‚ï¼šhttps://v.douyin.com/xxx/',
                kuaishou: 'è¯·ç²˜è´´å¿«æ‰‹è§†é¢‘é“¾æ¥ï¼Œå¦‚ï¼šhttps://www.kuaishou.com/short-video/xxx',
                bilibili: 'è¯·ç²˜è´´Bç«™è§†é¢‘é“¾æ¥ï¼Œå¦‚ï¼šhttps://www.bilibili.com/video/BVxxx'
            };
            input.placeholder = placeholders[currentPlatform];
        }

        // APIé€‰æ‹©å¤„ç†
        const apiSelect = document.getElementById('api-select');
        const customApiGroup = document.getElementById('custom-api-group');

        apiSelect.addEventListener('change', function() {
            if (this.value === 'custom') {
                customApiGroup.style.display = 'block';
            } else {
                customApiGroup.style.display = 'none';
            }
        });

        // ä¿å­˜è‡ªå®šä¹‰APIåˆ°æœ¬åœ°å­˜å‚¨
        const customApiInput = document.getElementById('custom-api');
        customApiInput.value = localStorage.getItem('customApi') || '';

        customApiInput.addEventListener('input', function() {
            localStorage.setItem('customApi', this.value);
        });

        // æµ‹è¯•APIæŒ‰é’®
        const testApisBtn = document.getElementById('test-apis-btn');
        testApisBtn.addEventListener('click', async function() {
            testApisBtn.disabled = true;
            testApisBtn.textContent = 'æµ‹è¯•ä¸­...';

            hideError();
            const testUrl = 'https://v.douyin.com/ZedjlY4D5YQ/';
            let results = [];

            for (let i = 0; i < builtInApis.length; i++) {
                const api = builtInApis[i];
                try {
                    updateApiStatus(`æ­£åœ¨æµ‹è¯• ${api.name}...`, '#667eea');
                    const startTime = Date.now();

                    const result = await fetchWithJSONP(api.url + encodeURIComponent(testUrl), api.type);
                    const duration = Date.now() - startTime;

                    if (result && (result.code === 200 || result.code === 0 || result.status === 'success')) {
                        results.push({
                            name: api.name,
                            status: 'âœ“ å¯ç”¨',
                            color: '#10b981',
                            duration: `${duration}ms`
                        });
                    } else {
                        results.push({
                            name: api.name,
                            status: 'âœ— å¤±è´¥',
                            color: '#ef4444',
                            duration: `${duration}ms`
                        });
                    }
                } catch (e) {
                    results.push({
                        name: api.name,
                        status: 'âœ— é”™è¯¯',
                        color: '#ef4444',
                        error: e.message
                    });
                }
            }

            // æ˜¾ç¤ºæµ‹è¯•ç»“æœ
            const errorDetails = document.getElementById('error-details');
            errorDetails.innerHTML = `
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-top: 10px;">
                    <p style="color: #667eea;"><strong>ğŸ§ª APIæµ‹è¯•ç»“æœ</strong></p>
                    ${results.map(r => `
                        <p style="margin: 5px 0; color: ${r.color};">
                            ${r.status} <strong>${r.name}</strong>
                            ${r.duration ? `(${r.duration})` : ''}
                            ${r.error ? ` - ${r.error}` : ''}
                        </p>
                    `).join('')}
                    <p style="margin-top: 10px; color: #666; font-size: 12px;">
                        ğŸ’¡ æµ‹è¯•å®Œæˆï¼Œå¯ä»¥å¼€å§‹ä½¿ç”¨
                    </p>
                </div>
            `;
            errorMessage.classList.add('show');
            updateApiStatus('æµ‹è¯•å®Œæˆ', '#667eea');

            testApisBtn.disabled = false;
            testApisBtn.textContent = 'æµ‹è¯•APIå¯ç”¨æ€§';
        });

        // è§£ææŒ‰é’®
        const parseBtn = document.getElementById('parse-btn');
        const loading = document.getElementById('loading');
        const resultContainer = document.getElementById('result-container');
        const errorMessage = document.getElementById('error-message');
        const videoPreview = document.getElementById('video-preview');
        const viewOriginalBtn = document.getElementById('view-original');
        const previewVideoBtn = document.getElementById('preview-video');
        let currentVideoUrl = ''; // ä¿å­˜å½“å‰è§†é¢‘URL
        let currentVideoInfo = null; // ä¿å­˜å½“å‰è§†é¢‘ä¿¡æ¯

        parseBtn.addEventListener('click', parseVideo);

        // æ”¯æŒå›è½¦é”®è§¦å‘
        document.getElementById('video-url').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                parseVideo();
            }
        });

        async function parseVideo() {
            const url = document.getElementById('video-url').value.trim();

            if (!url) {
                showError('è¯·è¾“å…¥è§†é¢‘é“¾æ¥');
                return;
            }

            if (!isValidUrl(url)) {
                showError('è¯·è¾“å…¥æœ‰æ•ˆçš„è§†é¢‘é“¾æ¥');
                return;
            }

            currentVideoUrl = url;
            viewOriginalBtn.disabled = true;

            hideError();
            resultContainer.classList.remove('show');
            loading.classList.add('show');
            parseBtn.disabled = true;

            try {
                updateApiStatus('æ­£åœ¨è¯·æ±‚API...', '#667eea');
                const result = await fetchVideoInfo(url);
                currentVideoInfo = result; // ä¿å­˜å½“å‰è§†é¢‘ä¿¡æ¯
                displayResult(result);
            } catch (error) {
                updateApiStatus('è§£æå¤±è´¥', '#ef4444');
                showError(error.message || 'è§£æå¤±è´¥ï¼Œè¯·æ£€æŸ¥é“¾æ¥æ˜¯å¦æ­£ç¡®');
            } finally {
                loading.classList.remove('show');
                parseBtn.disabled = false;
            }
        }

        function isValidUrl(string) {
            try {
                new URL(string);
                return true;
            } catch (_) {
                return false;
            }
        }

        async function fetchVideoInfo(url) {
            // æ£€æµ‹è§†é¢‘å¹³å°
            let platform = detectPlatform(url);

            // è·å–ç”¨æˆ·é€‰æ‹©çš„API
            const selectedApi = apiSelect.value;

            let apisToTry = [];

            // æ ¹æ®ç”¨æˆ·é€‰æ‹©ç¡®å®šè¦å°è¯•çš„API
            if (selectedApi === 'custom') {
                const customApiUrl = customApiInput.value.trim();
                if (!customApiUrl) {
                    throw new Error('è¯·è¾“å…¥è‡ªå®šä¹‰APIåœ°å€');
                }
                apisToTry = [{
                    name: 'è‡ªå®šä¹‰API',
                    url: customApiUrl,
                    type: 'json'
                }];
            } else if (selectedApi === 'auto') {
                // è‡ªåŠ¨æ¨¡å¼ï¼Œä¾æ¬¡å°è¯•æ‰€æœ‰API
                apisToTry = builtInApis;
            } else {
                // é€‰æ‹©ç‰¹å®šAPI
                const apiIndex = parseInt(selectedApi.replace('api', '')) - 1;
                if (builtInApis[apiIndex]) {
                    apisToTry = [builtInApis[apiIndex]];
                }
            }

            // å°è¯•æ¯ä¸ªAPI - è¿œæ¢¦APIä½¿ç”¨JSONPæ–¹å¼
            for (const api of apisToTry) {
                try {
                    console.log(`å°è¯•${api.name}:`, api.url);
                    updateApiStatus(`æ­£åœ¨å°è¯• ${api.name}...`, '#f59e0b');

                    const apiUrl = api.url + encodeURIComponent(url);
                    const result = await fetchWithJSONP(apiUrl, api.type);

                    console.log(`${api.name}è¿”å›:`, result);

                    if (result && (result.code === 200 || result.code === 0 || result.status === 'success' || result.url || result.data)) {
                        console.log(`${api.name}æˆåŠŸ:`, result);
                        updateApiStatus(`âœ“ ${api.name} æˆåŠŸ`, '#10b981');
                        return normalizeResult(result, url, platform);
                    } else if (result) {
                        console.log(`${api.name}è¿”å›å¼‚å¸¸:`, result);
                        throw new Error(`APIè¿”å›é”™è¯¯: code=${result.code}`);
                    }
                } catch (e) {
                    console.log(`${api.name}å¤±è´¥:`, e);
                    updateApiStatus(`âœ— ${api.name} å¤±è´¥`, '#ef4444');
                    // å¦‚æœä¸æ˜¯è‡ªåŠ¨æ¨¡å¼ï¼Œç›´æ¥æŠ›å‡ºé”™è¯¯
                    if (selectedApi !== 'auto' && !selectedApi.startsWith('api')) {
                        throw new Error(`${api.name} è§£æå¤±è´¥: ${e.message}`);
                    }
                    continue;
                }
            }

            // å¦‚æœæ‰€æœ‰APIéƒ½å¤±è´¥ï¼Œæä¾›iframeåµŒå…¥æ–¹æ¡ˆ
            console.log('æ‰€æœ‰APIå¤±è´¥ï¼Œå°è¯•iframeæ–¹æ¡ˆ');
            updateApiStatus('APIå…¨éƒ¨å¤±è´¥ï¼Œä½¿ç”¨iframeæ–¹æ¡ˆ', '#f59e0b');
            return {
                title: 'è§†é¢‘é¢„è§ˆ',
                author: 'æ— æ³•è·å–',
                duration: '-',
                url: url,
                cover: '',
                useIframe: true,
                originalUrl: url,
                platform
            };
        }

        function updateApiStatus(status, color) {
            const apiStatus = document.getElementById('api-status');
            apiStatus.textContent = `â— ${status}`;
            apiStatus.style.color = color;
        }

        // ä½¿ç”¨å¤šç§æ–¹å¼è·å–æ•°æ®ï¼ˆå…ˆå°è¯•fetchï¼Œå†å°è¯•JSONPï¼‰
        function fetchWithJSONP(url, type) {
            return new Promise((resolve, reject) => {
                // æ–¹æ³•1: ç›´æ¥fetchï¼ˆæ”¯æŒCORSçš„APIï¼‰
                fetch(url, {
                    method: 'GET',
                    headers: { 'Accept': 'application/json' },
                    mode: 'cors',
                    credentials: 'omit'
                })
                .then(response => {
                    if (response.ok) {
                        return response.text();
                    }
                    throw new Error('HTTP ' + response.status);
                })
                .then(text => {
                    try {
                        const data = JSON.parse(text);
                        console.log('FetchæˆåŠŸ:', data);
                        resolve(data);
                    } catch (e) {
                        console.log('JSONè§£æå¤±è´¥ï¼Œå°è¯•ä»£ç†');
                        return fetchViaProxy(url);
                    }
                })
                .catch(err => {
                    console.log('Fetchå¤±è´¥ï¼Œå°è¯•ä»£ç†:', err);
                    return fetchViaProxy(url);
                })
                .then(resolve)
                .catch(reject);
            });
        }

        // é€šè¿‡AllOriginsä»£ç†è§„é¿CORSï¼Œä»ç„¶è¿”å›JSONæ–‡æœ¬
        function fetchViaProxy(url) {
            const proxyUrl = 'https://api.allorigins.win/raw?url=' + encodeURIComponent(url);
            return fetch(proxyUrl)
                .then(res => {
                    if (!res.ok) throw new Error('Proxy HTTP ' + res.status);
                    return res.text();
                })
                .then(text => {
                    try {
                        return JSON.parse(text);
                    } catch (e) {
                        console.log('ä»£ç†JSONè§£æå¤±è´¥ï¼Œå°è¯•JSONP');
                        return fetchWithJSONPMode(url);
                    }
                })
                .catch(err => {
                    console.log('ä»£ç†å¤±è´¥ï¼Œå°è¯•JSONP:', err);
                    return fetchWithJSONPMode(url);
                });
        }

        // çº¯JSONPæ–¹å¼ï¼ˆå¤‡ç”¨ï¼‰
        function fetchWithJSONPMode(url) {
            return new Promise((resolve, reject) => {
                // åˆ›å»ºä¸€ä¸ªå”¯ä¸€çš„å›è°ƒå‡½æ•°å
                const callbackName = 'jsonp_callback_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);

                // åˆ›å»ºscriptæ ‡ç­¾
                const script = document.createElement('script');
                script.src = url.includes('?') ? url + '&callback=' + callbackName : url + '?callback=' + callbackName;
                script.async = true;

                // è®¾ç½®å…¨å±€å›è°ƒå‡½æ•°
                window[callbackName] = function(data) {
                    console.log('JSONPæˆåŠŸ:', data);
                    // æ¸…ç†
                    delete window[callbackName];
                    if (script.parentNode) {
                        document.body.removeChild(script);
                    }
                    resolve(data);
                };

                // è®¾ç½®è¶…æ—¶
                const timeout = setTimeout(() => {
                    console.log('è¯·æ±‚è¶…æ—¶');
                    delete window[callbackName];
                    if (script.parentNode) {
                        document.body.removeChild(script);
                    }
                    reject(new Error('è¯·æ±‚è¶…æ—¶'));
                }, 8000);

                script.onerror = function() {
                    console.log('ScriptåŠ è½½å¤±è´¥');
                    clearTimeout(timeout);
                    delete window[callbackName];
                    if (script.parentNode) {
                        document.body.removeChild(script);
                    }
                    reject(new Error('åŠ è½½å¤±è´¥'));
                };

                script.onload = function() {
                    // å¦‚æœå›è°ƒæ²¡æœ‰åœ¨300mså†…è¢«è°ƒç”¨ï¼Œè¯´æ˜å¯èƒ½ä¸æ”¯æŒJSONP
                    setTimeout(() => {
                        if (window[callbackName]) {
                            clearTimeout(timeout);
                            delete window[callbackName];
                            if (script.parentNode) {
                                document.body.removeChild(script);
                            }
                            reject(new Error('APIä¸æ”¯æŒJSONP'));
                        }
                    }, 300);
                };

                document.body.appendChild(script);
            });
        }

        function detectPlatform(url) {
            if (url.includes('douyin.com') || url.includes('v.douyin.com')) {
                return 'douyin';
            } else if (url.includes('kuaishou.com')) {
                return 'kuaishou';
            } else if (url.includes('bilibili.com') || url.includes('b23.tv')) {
                return 'bilibili';
            }
            return 'douyin';
        }

        function normalizeResult(data, originalUrl, platform) {
            console.log('å¼€å§‹è§„èŒƒåŒ–æ•°æ®:', data);

            // å¤„ç†ä¸åŒAPIè¿”å›çš„æ ¼å¼
            let result = {
                title: 'æœªè·å–åˆ°æ ‡é¢˜',
                author: 'æœªçŸ¥ä½œè€…',
                duration: '-',
                url: '',
                urlHQ: '',
                cover: '',
                useIframe: false,
                originalUrl: originalUrl,
                platform
            };

            // å…¼å®¹å¤šç§APIè¿”å›æ ¼å¼
            let apiData = data.data || data;

            // æ£€æŸ¥APIè¿”å›çŠ¶æ€ç ï¼ˆæœ‰äº›APIç”¨codeï¼Œæœ‰äº›ç”¨statusï¼‰
            if (data.code !== undefined && data.code !== 200 && data.code !== 0) {
                // æŸäº›APIè¿”å›msgä½œä¸ºé”™è¯¯ä¿¡æ¯
                if (data.msg || data.message) {
                    throw new Error(data.msg || data.message);
                }
                throw new Error(`APIè¿”å›é”™è¯¯ç : ${data.code}`);
            }

            if (data.status !== undefined && data.status !== 'success' && data.status !== 200) {
                throw new Error(`APIè¿”å›çŠ¶æ€: ${data.status}`);
            }

            // æå–è§†é¢‘ä¿¡æ¯ï¼ˆå…¼å®¹å¤šç§å­—æ®µåï¼‰
            result.title = apiData.desc || apiData.title || apiData.text || apiData.content || result.title;
            result.author = apiData.nickname || apiData.author || apiData.user || apiData.uploader || result.author;
            result.url = apiData.video_url || apiData.url || apiData.play_addr || apiData.href || result.url;
            result.urlHQ = apiData.video_url_HQ || apiData.hd_url || apiData.url_hq || apiData.play_addr_h264_br || result.url;
            result.cover = apiData.cover || apiData.pic || apiData.thumbnail || apiData.avatar || apiData.poster || apiData.dynamic_cover || result.cover;

            // é’ˆå¯¹æŠ–éŸ³ç­‰å¹³å°è¡¥é½æ’­æ”¾å‚æ•°ï¼Œé™ä½é˜²ç›—é“¾å¯¼è‡´çš„æ— æ³•æ’­æ”¾
            result.url = enhancePlaybackUrl(result.url, platform);
            result.urlHQ = enhancePlaybackUrl(result.urlHQ, platform);

            console.log('è§„èŒƒåŒ–åçš„ç»“æœ:', result);

            // å¦‚æœæ²¡æœ‰è§†é¢‘URLï¼Œä½¿ç”¨iframeæ–¹æ¡ˆ
            if (!result.url) {
                result.useIframe = true;
                return result;
            }

            return result;
        }

        // ä¸ºæ˜“é˜²ç›—é“¾çš„å¹³å°è¡¥é½æ’­æ”¾å‚æ•°
        function enhancePlaybackUrl(url, platform) {
            if (!url) return url;
            try {
                const u = new URL(url);
                if (platform === 'douyin') {
                    u.searchParams.set('is_play_url', '1');
                    u.searchParams.set('line', u.searchParams.get('line') || '0');
                    if (!u.searchParams.get('ratio')) {
                        u.searchParams.set('ratio', '720p');
                    }
                    if (!u.searchParams.get('media_type')) {
                        u.searchParams.set('media_type', '4');
                    }
                }
                return u.toString();
            } catch (e) {
                return url;
            }
        }

        function displayResult(result) {
            document.getElementById('video-title').textContent = result.title;
            document.getElementById('video-author').textContent = result.author;
            document.getElementById('video-duration').textContent = result.duration;

            // æ¸…ç©ºä¹‹å‰çš„è§†é¢‘å†…å®¹
            videoPreview.innerHTML = '';

            if (result.useIframe) {
                // ä½¿ç”¨iframeæ–¹å¼é¢„è§ˆï¼Œç›´æ¥ä½¿ç”¨video_url
                const iframe = document.createElement('iframe');
                iframe.src = result.url || result.video_url;
                iframe.style.width = '100%';
                iframe.style.height = '100%';
                iframe.style.minHeight = '400px';
                iframe.style.border = 'none';
                iframe.setAttribute('allowfullscreen', '');
                iframe.setAttribute('allow', 'autoplay; fullscreen');
                videoPreview.appendChild(iframe);
                
                // ç¦ç”¨ä¸‹è½½æŒ‰é’®
                document.getElementById('download-hd').disabled = true;
                document.getElementById('download-sd').disabled = true;
                document.getElementById('download-hd').textContent = 'ğŸ”’ æ— æ³•ä¸‹è½½';
                document.getElementById('download-sd').textContent = 'ğŸ”’ æ— æ³•ä¸‹è½½';

                // ä»å¯æŸ¥çœ‹åŸè§†é¢‘
                viewOriginalBtn.disabled = false;
                viewOriginalBtn.onclick = () => openOriginalVideo(result.originalUrl || currentVideoUrl);

                // ç¦ç”¨é¢„è§ˆæŒ‰é’®ï¼ˆiframeæ¨¡å¼ï¼‰
                previewVideoBtn.disabled = true;
                previewVideoBtn.textContent = 'ğŸ”’ æ— æ³•é¢„è§ˆ';
            } else if (result.url) {
                // ä½¿ç”¨videoæ ‡ç­¾é¢„è§ˆï¼ˆä¼˜å…ˆä½¿ç”¨é«˜æ¸…ç‰ˆæœ¬ï¼‰ï¼Œå¹¶æ·»åŠ å‡ºé”™é™çº§
                const video = document.createElement('video');
                const sources = [result.urlHQ, result.url].filter(Boolean);
                let sourceIndex = 0;
                video.src = sources[sourceIndex];
                video.controls = true;
                video.playsInline = true;
                video.preload = 'metadata';
                video.style.width = '100%';
                video.style.height = 'auto';
                if (result.cover) {
                    video.poster = result.cover;
                }

                // å¦‚æœæ’­æ”¾å¤±è´¥ï¼Œå°è¯•ä¸‹ä¸€æ¡æºï¼›éƒ½å¤±è´¥åˆ™æç¤ºå¹¶æ‰“å¼€åŸè§†é¢‘
                video.addEventListener('error', () => {
                    if (sourceIndex + 1 < sources.length) {
                        sourceIndex += 1;
                        video.src = sources[sourceIndex];
                        video.load();
                    } else {
                        showError('è§†é¢‘æ’­æ”¾å¤±è´¥ï¼Œå¯èƒ½è¢«é˜²ç›—é“¾ï¼Œå·²ä¸ºä½ ä¿ç•™åŸè§†é¢‘é“¾æ¥');
                    }
                });

                videoPreview.appendChild(video);
                
                // è®¾ç½®ä¸‹è½½æŒ‰é’®
                const downloadHd = document.getElementById('download-hd');
                const downloadSd = document.getElementById('download-sd');
                
                // å¦‚æœæœ‰é«˜æ¸…ç‰ˆæœ¬ï¼Œä½¿ç”¨é«˜æ¸…ï¼›å¦åˆ™ä½¿ç”¨æ ‡æ¸…
                const hasHQ = !!result.urlHQ;
                downloadHd.innerHTML = '<span>ğŸ“¥</span> é«˜æ¸…ä¸‹è½½';
                downloadSd.innerHTML = '<span>ğŸ“¥</span> æ ‡æ¸…ä¸‹è½½';
                
                downloadHd.disabled = false;
                downloadSd.disabled = false;
                
                // é«˜æ¸…ä¸‹è½½
                downloadHd.onclick = () => {
                    const url = result.urlHQ || result.url;
                    downloadVideo(url, result.title, 'hd');
                };
                
                // æ ‡æ¸…ä¸‹è½½
                downloadSd.onclick = () => {
                    downloadVideo(result.url, result.title, 'sd');
                };

                // åŸè§†é¢‘æŒ‰é’®å¯ç”¨
                viewOriginalBtn.disabled = false;
                viewOriginalBtn.onclick = () => openOriginalVideo(result.originalUrl || currentVideoUrl);

                // æ–°çª—å£é¢„è§ˆæŒ‰é’®å¯ç”¨
                previewVideoBtn.disabled = false;
                previewVideoBtn.innerHTML = '<span>ğŸ¬</span> æ–°çª—å£é¢„è§ˆ';
                previewVideoBtn.onclick = () => openVideoPreview(result);
            }

            resultContainer.classList.add('show');
        }

        function openOriginalVideo(url) {
            if (!url) {
                showError('æœªæ‰¾åˆ°åŸè§†é¢‘é“¾æ¥');
                return;
            }
            window.open(url, '_blank');
        }

        function openVideoPreview(result) {
            if (!result || !result.url) {
                showError('æœªæ‰¾åˆ°è§†é¢‘åœ°å€');
                return;
            }
            window.open(result.url, '_blank');
        }

        function downloadVideo(url, title, quality) {
            // æ¸…ç†æ–‡ä»¶åä¸­çš„ç‰¹æ®Šå­—ç¬¦
            const safeTitle = title.replace(/[^\w\s\u4e00-\u9fa5]/gi, '_').substring(0, 50);
            const fileName = `${safeTitle}_${quality}.mp4`;
            
            // æ£€æŸ¥æ˜¯å¦æ˜¯iframeæ¨¡å¼çš„URL
            if (url.includes('douyin.com') || url.includes('kuaishou.com') || url.includes('bilibili.com')) {
                // iframeæ¨¡å¼ï¼Œåœ¨æ–°çª—å£æ‰“å¼€
                window.open(url, '_blank');
                return;
            }
            
            // æ–¹æ³•1: å°è¯•ä½¿ç”¨fetchä¸‹è½½ï¼ˆé€‚ç”¨äºæ”¯æŒCORSçš„é“¾æ¥ï¼‰
            if (url.startsWith('http')) {
                try {
                    // åˆ›å»ºä¸‹è½½é“¾æ¥
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = fileName;
                    link.target = '_blank';
                    link.style.display = 'none';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                } catch (e) {
                    // å¦‚æœç›´æ¥ä¸‹è½½å¤±è´¥ï¼Œåœ¨æ–°çª—å£æ‰“å¼€
                    console.log('ç›´æ¥ä¸‹è½½å¤±è´¥ï¼Œå°è¯•æ–°çª—å£æ‰“å¼€:', e);
                    window.open(url, '_blank');
                }
            } else {
                // æ–°çª—å£æ‰“å¼€
                window.open(url, '_blank');
            }
        }

        function showError(message) {
            const errorText = document.getElementById('error-text');
            const errorDetails = document.getElementById('error-details');

            errorText.textContent = message;

            // æ ¹æ®é”™è¯¯ç±»å‹æä¾›å…·ä½“çš„è§£å†³å»ºè®®
            if (message.includes('è§£æå¤±è´¥') || message.includes('æœªèƒ½è·å–')) {
                errorDetails.innerHTML = `
                    <p style="margin-top: 8px;"><strong>ğŸ’¡ æ¨èè§£å†³æ–¹æ¡ˆï¼š</strong></p>
                    <p style="margin: 5px 0;">1. <strong>æŠ–éŸ³ï¼š</strong>ä½¿ç”¨ <a href="https://www.douyin.com" target="_blank" style="color: #667eea;">æŠ–éŸ³å®˜ç½‘</a> æˆ–å®‰è£…"çŒ«æŠ“"æµè§ˆå™¨æ’ä»¶</p>
                    <p style="margin: 5px 0;">2. <strong>å¿«æ‰‹ï¼š</strong>ä½¿ç”¨ <a href="https://www.kuaishou.com" target="_blank" style="color: #667eea;">å¿«æ‰‹å®˜ç½‘</a> æˆ–ä¸“ä¸šä¸‹è½½å·¥å…·</p>
                    <p style="margin: 5px 0;">3. <strong>Bç«™ï¼š</strong>ä½¿ç”¨ <a href="https://www.bilibili.com" target="_blank" style="color: #667eea;">Bç«™å®˜ç½‘</a> å®‰è£…"Bilibili Evolved"æ’ä»¶</p>
                    <p style="margin: 5px 0;">4. <strong>é€šç”¨æ–¹æ¡ˆï¼š</strong>ä½¿ç”¨ <a href="https://www.bilibili.com" target="_blank" style="color: #667eea;">IDMä¸‹è½½å™¨</a> æˆ– <a href="https://www.4kdownload.com/" target="_blank" style="color: #667eea;">4K Video Downloader</a></p>
                    <p style="margin: 5px 0;">5. <strong>åœ¨çº¿å·¥å…·ï¼š</strong>æœç´¢"è§†é¢‘è§£æä¸‹è½½"å¯æ‰¾åˆ°å¤šä¸ªåœ¨çº¿å·¥å…·</p>
                `;
            } else if (message.includes('è¶…æ—¶')) {
                errorDetails.innerHTML = `
                    <p style="margin-top: 8px;"><strong>â° è¯·æ±‚è¶…æ—¶ï¼Œå¯èƒ½åŸå› ï¼š</strong></p>
                    <p style="margin: 5px 0;">1. ç½‘ç»œè¿æ¥ä¸ç¨³å®šï¼Œè¯·æ£€æŸ¥ç½‘ç»œ</p>
                    <p style="margin: 5px 0;">2. APIæœåŠ¡å™¨å“åº”è¿‡æ…¢</p>
                    <p style="margin: 5px 0;">3. é˜²ç«å¢™é˜»æ­¢äº†è¯·æ±‚</p>
                `;
            } else if (message.includes('è§†é¢‘æ’­æ”¾å¤±è´¥') || message.includes('é˜²ç›—é“¾')) {
                errorDetails.innerHTML = `
                    <p style="margin-top: 8px;"><strong>ğŸ”§ æ’­æ”¾å¤±è´¥è§£å†³æ–¹æ¡ˆï¼š</strong></p>
                    <p style="margin: 5px 0;">1. <strong>æŸ¥çœ‹åŸè§†é¢‘ï¼š</strong>ç‚¹å‡»ä¸‹æ–¹"æŸ¥çœ‹åŸè§†é¢‘"æŒ‰é’®åœ¨åŸå¹³å°è§‚çœ‹</p>
                    <p style="margin: 5px 0;">2. <strong>å°è¯•ä¸‹è½½ï¼š</strong>ç‚¹å‡»"é«˜æ¸…ä¸‹è½½"æˆ–"æ ‡æ¸…ä¸‹è½½"æŒ‰é’®å°è¯•ç›´æ¥ä¸‹è½½è§†é¢‘</p>
                    <p style="margin: 5px 0;">3. <strong>é˜²ç›—é“¾é™åˆ¶ï¼š</strong>éƒ¨åˆ†è§†é¢‘å¯èƒ½å› é˜²ç›—é“¾å¯¼è‡´æ— æ³•åœ¨çº¿æ’­æ”¾ï¼Œä½†é€šå¸¸å¯ä»¥ä¸‹è½½</p>
                    <p style="margin: 5px 0;">4. <strong>åˆ·æ–°é‡è¯•ï¼š</strong>åˆ·æ–°é¡µé¢åé‡æ–°è§£æè§†é¢‘</p>
                `;
            } else {
                errorDetails.innerHTML = `
                    <p style="margin-top: 8px;"><strong>ğŸ”§ å…¶ä»–è§£å†³æ–¹æ¡ˆï¼š</strong></p>
                    <p style="margin: 5px 0;">1. ç¡®è®¤è§†é¢‘é“¾æ¥æ˜¯å¦æ­£ç¡®ä¸”å¯è®¿é—®</p>
                    <p style="margin: 5px 0;">2. å°è¯•åˆ·æ–°é¡µé¢åé‡æ–°è§£æ</p>
                    <p style="margin: 5px 0;">3. ä½¿ç”¨æµè§ˆå™¨å¼€å‘è€…å·¥å…·æŸ¥çœ‹è¯¦ç»†é”™è¯¯</p>
                `;
            }

            errorMessage.classList.add('show');
        }

        function hideError() {
            errorMessage.classList.remove('show');
        }

        // åˆå§‹åŒ–
        updatePlaceholder();
    </script>

</body>
</html>
