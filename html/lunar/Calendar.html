<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸‡èƒ½æ—¥å†</title>
    <script src="lunar.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', 'PingFang SC', sans-serif;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .main-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(20px);
            display: flex;
            gap: 30px;
            padding: 30px;
            max-width: 1400px;
            width: 100%;
            backdrop-filter: blur(10px);
        }

        .calendar-section {
            flex: 2;
        }

        .detail-section {
            flex: 1;
            min-width: 350px;
            max-width: 400px;
            display: flex;
            flex-direction: column;
        }





        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #4ECDC4, #44A08D);
            border-radius: 15px;
            color: white;
        }

        .nav-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .nav-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .festival-selector {
            position: relative;
            display: inline-block;
        }

        .festival-toggle {
            background: linear-gradient(135deg, #9C27B0, #7B1FA2);
            border: 1px solid #9C27B0;
        }

        .festival-toggle:hover {
            background: linear-gradient(135deg, #7B1FA2, #9C27B0);
        }

        .theme-selector {
            position: relative;
            display: inline-block;
        }

        .theme-toggle {
            background: linear-gradient(135deg, #2196F3, #1976D2);
            border: 1px solid #2196F3;
        }

        .theme-toggle:hover {
            background: linear-gradient(135deg, #1976D2, #2196F3);
        }

        .theme-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border: 1px solid #ccc;
            border-radius: 8px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
            padding: 8px;
            min-width: 140px;
            z-index: 1000;
            display: none;
            margin-top: 5px;
        }

        .theme-dropdown.show {
            display: block;
        }

        .theme-option {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            border-radius: 6px;
            font-size: 13px;
            gap: 8px;
            color: #333;
            font-weight: 500;
        }

        .theme-option:hover {
            background-color: #f0f0f0;
            color: #1976D2;
        }

        .theme-option.active {
            background-color: #1976D2;
            color: white;
            font-weight: bold;
        }

        .theme-icon {
            font-size: 16px;
            min-width: 20px;
        }

        .festival-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border: 1px solid #ccc;
            border-radius: 8px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
            padding: 12px;
            min-width: 140px;
            z-index: 1000;
            display: none;
            margin-top: 5px;
        }

        .festival-dropdown.show {
            display: block;
        }

        .festival-option {
            display: flex;
            align-items: center;
            padding: 6px 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            border-radius: 4px;
            font-size: 13px;
            color: #333;
        }

        .festival-option:hover {
            background-color: #f0f0f0;
        }

        .festival-option input[type="checkbox"] {
            margin-right: 8px;
            transform: scale(1.1);
        }

        .festival-option span {
            color: #333;
            user-select: none;
        }

        .today-btn {
            background: linear-gradient(135deg, #FF6B6B, #E6A23C);
            border: 1px solid #FF6B6B;
        }

        .today-btn:hover {
            background: linear-gradient(135deg, #E6A23C, #FF6B6B);
            transform: translateY(-2px);
        }

        .date-selector {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .year-input, .month-select {
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.5);
            color: #333;
            padding: 8px 12px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 80px;
        }

        .year-input {
            min-width: 100px;
            text-align: center;
            font-size: 16px;
        }

        .month-select {
            font-size: 14px;
        }

        .year-input::-webkit-inner-spin-button, .year-input::-webkit-outer-spin-button {
            opacity: 1;
        }

        .year-input:focus, .month-select:focus {
            background: white;
            border-color: white;
            outline: none;
            box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.3);
        }

        .year-input::placeholder {
            color: #999;
            font-weight: normal;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 10px;
            background: rgba(255, 255, 255, 0.8);
            padding: 20px;
            border-radius: 15px;
        }

        .weekday {
            text-align: center;
            padding: 15px 0;
            font-weight: bold;
            color: #4ECDC4;
            font-size: 16px;
            border-bottom: 2px solid #4ECDC4;
        }

        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .calendar-day.weekend {
            background: linear-gradient(135deg, #fff9e6, #ffe6cc);
            border-color: #ffcc80;
        }

        /* é¼ æ ‡æ‚¬åœæç¤ºæ¡†æ ·å¼ */
        .date-tooltip {
            position: fixed;
            background: rgba(255, 255, 255, 0.98);
            border: 1px solid #ddd;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            padding: 20px;
            min-width: 320px;
            max-width: 400px;
            z-index: 1000;
            backdrop-filter: blur(10px);
            display: none;
            font-family: 'Microsoft YaHei', 'PingFang SC', sans-serif;
            /* å›ºå®šåœ¨å³ä¸‹è§’ */
            right: 20px;
            bottom: 20px;
            left: auto;
            top: auto;
        }

        .date-tooltip.show {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .tooltip-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .tooltip-date {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }

        .tooltip-lunar {
            font-size: 14px;
            color: #666;
            margin-top: 2px;
        }

        .tooltip-jieqi {
            display: flex;
            align-items: center;
            margin: 10px 0;
            padding: 8px 12px;
            background: linear-gradient(135deg, #f0f8ff, #e6f3ff);
            border-radius: 8px;
            border-left: 3px solid #4ECDC4;
        }

        .tooltip-jieqi img {
            width: 80px;
            height: 80px;
            border-radius: 8px;
            margin-right: 15px;
            object-fit: cover;
            border: 2px solid rgba(78, 205, 196, 0.3);
        }

        .tooltip-jieqi-info {
            flex: 1;
        }

        .tooltip-jieqi-name {
            font-weight: bold;
            color: #4ECDC4;
            font-size: 14px;
        }

        .tooltip-jieqi-desc {
            font-size: 12px;
            color: #666;
            margin-top: 2px;
        }

        /* ä¸‰ä¼ä¸‰ä¹æ ·å¼ */
        .tooltip-fu-jiu {
            margin: 10px 0;
            padding: 8px 12px;
            background: linear-gradient(135deg, #fff8f0, #fff0e6);
            border-radius: 8px;
            border-left: 3px solid #FFA500;
        }

        .tooltip-fu-jiu-title {
            font-size: 13px;
            font-weight: bold;
            color: #FFA500;
            margin-bottom: 6px;
        }

        .tooltip-fu-jiu-content {
            display: flex;
            gap: 10px;
        }

        #tooltipFu, #tooltipJiu {
            flex: 1;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            text-align: center;
        }

        #tooltipFu {
            background: rgba(255, 107, 107, 0.1);
            color: #FF6B6B;
            border: 1px solid rgba(255, 107, 107, 0.3);
        }

        #tooltipJiu {
            background: rgba(78, 205, 196, 0.1);
            color: #4ECDC4;
            border: 1px solid rgba(78, 205, 196, 0.3);
        }

        .tooltip-festivals {
            margin: 10px 0;
        }

        .tooltip-festival-title {
            font-size: 14px;
            font-weight: bold;
            color: #FF6B6B;
            margin-bottom: 8px;
        }

        .tooltip-festival-list {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .tooltip-festival-item {
            background: linear-gradient(135deg, #fff0f0, #ffe6e6);
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            color: #d63384;
            border: 1px solid #ffcccc;
        }

        /* æ—¥æœŸè®¡ç®—ä¿¡æ¯æ ·å¼ */
        .tooltip-date-info {
            margin: 12px 0;
            padding: 10px;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 6px;
            border-left: 2px solid #9C27B0;
            font-size: 11px;
        }

        .date-info-row {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 4px;
        }

        .date-info-item {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            gap: 2px;
            margin-bottom: 0;
        }

        .date-info-item:last-child {
            margin-bottom: 0;
        }

        .info-label {
            color: #666;
            font-weight: normal;
        }

        .info-value {
            color: #9C27B0;
            font-weight: bold;
            background: rgba(156, 39, 176, 0.1);
            padding: 1px 4px;
            border-radius: 3px;
            min-width: 20px;
            text-align: center;
            margin: 0 2px;
        }

        .tooltip-holiday {
            margin: 10px 0;
            padding: 8px 12px;
            background: linear-gradient(135deg, #f0fff0, #e6ffe6);
            border-radius: 8px;
            border-left: 3px solid #5CB85C;
        }

        .tooltip-holiday.rest {
            background: linear-gradient(135deg, #f0fff0, #e6ffe6);
            border-left-color: #5CB85C;
        }

        .tooltip-holiday.work {
            background: linear-gradient(135deg, #fff8e6, #fff0cc);
            border-left-color: #E6A23C;
        }

        .tooltip-holiday-symbol {
            font-weight: bold;
            font-size: 14px;
            margin-right: 6px;
        }

        .tooltip-holiday-name {
            font-weight: bold;
            font-size: 13px;
        }

        .calendar-day:hover {
            border-color: #4ECDC4;
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(78, 205, 196, 0.3);
            z-index: 10;
        }

        .calendar-day.selected {
            background: linear-gradient(135deg, #4ECDC4, #44A08D);
            color: white;
            border-color: #4ECDC4;
        }

        .calendar-day.other-month {
            opacity: 0.4;
            background: #f8f9fa;
        }

        .calendar-day.today {
            background: linear-gradient(135deg, #FF6B6B, #E6A23C);
            color: white;
            border-color: #FF6B6B;
            font-weight: bold;
        }

        .day-number {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 3px;
        }

        .lunar-day {
            font-size: 11px;
            color: #666;
            text-align: center;
        }

        .festival-tag {
            position: absolute;
            top: 2px;
            left: 50%;
            transform: translateX(-50%);
            background: #FF6B6B;
            color: white;
            font-size: 9px;
            padding: 1px 4px;
            border-radius: 8px;
            font-weight: bold;
            z-index: 10;
            white-space: nowrap;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            pointer-events: none; /* é˜²æ­¢æ‹¦æˆªé¼ æ ‡äº‹ä»¶ */
        }

        .festival-tag:hover {
            transform: translateX(-50%) scale(1.1);
            box-shadow: 0 2px 8px rgba(255, 107, 107, 0.4);
            z-index: 11;
        }

        .jieqi-tag {
            position: absolute;
            bottom: 2px;
            left: 2px;
            background: #4ECDC4;
            color: white;
            font-size: 8px;
            padding: 1px 4px;
            border-radius: 5px;
            z-index: 10;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .jieqi-tag:hover {
            transform: scale(1.1);
            box-shadow: 0 2px 8px rgba(78, 205, 196, 0.4);
            z-index: 11;
        }

        /* ä¸‰ä¹ä¿¡æ¯æ ‡ç­¾ - æ”¾åœ¨å³ä¸‹è§’ */
        .fu-jiu-tag {
            position: absolute;
            bottom: 2px;
            right: 2px;
            background: #FFA500;
            color: white;
            font-size: 7px;
            padding: 1px 3px;
            border-radius: 4px;
            z-index: 10;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            font-weight: bold;
        }

        .fu-jiu-tag:hover {
            transform: scale(1.1);
            box-shadow: 0 2px 8px rgba(255, 165, 0, 0.4);
            z-index: 11;
        }



        .holiday-tag {
            position: absolute;
            top: 2px;
            right: 2px;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            z-index: 10;
            pointer-events: none;
        }

        /* ä¼‘å‡ç”¨ç»¿è‰²åœ†ç‚¹ */
        .holiday-tag.rest {
            background: #5CB85C;
        }

        /* è°ƒä¼‘ç”¨é»„è‰²åœ†ç‚¹ */
        .holiday-tag.work {
            background: #E6A23C;
        }



        .empty-state {
            text-align: center;
            color: #999;
            font-style: italic;
            padding: 40px 20px;
        }

        .huangli {
            background: white;
            padding: 8px;
            height: 100%;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .solar-date {
            font-size: 14px;
            font-weight: bold;
            color: #4ECDC4;
            margin: 0;
            text-align: left;
            background: linear-gradient(135deg, #f0f8ff, #e6f3ff);
            padding: 4px 8px;
            border-radius: 0 6px 6px 0;
            border-left: 3px solid #4ECDC4;
            align-self: flex-start;
        }

        #md {
            font-size: 16px;
            font-weight: bold;
            color: #333;
            text-align: center;
            margin: 0;
        }

        #ymd {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            justify-content: center;
            margin: 0;
        }

        #ymd i {
            background: linear-gradient(135deg, #4ECDC4, #44A08D);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-style: normal;
        }

        .nayin, .chongsha, .pengzu {
            display: flex;
            align-items: center;
            margin-bottom: 4px;
            padding: 4px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .nayin b, .chongsha b, .pengzu b {
            color: #4ECDC4;
            font-size: 13px;
            margin-right: 10px;
            min-width: 40px;
        }

        .nayin i, .chongsha i, .pengzu i {
            color: #666;
            font-size: 12px;
            font-style: normal;
        }

        .fangwei-container {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
            padding: 4px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .fangwei-item {
            flex: 1;
            text-align: center;
            padding: 4px;
        }

        .fangwei-item b {
            display: block;
            color: #4ECDC4;
            font-size: 11px;
            margin-bottom: 2px;
        }

        .fangwei-item i {
            display: block;
            color: #666;
            font-size: 11px;
            font-style: normal;
        }

        .festival-section {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e9ecef;
        }

        .festival-title {
            font-size: 14px;
            font-weight: bold;
            color: #4ECDC4;
            margin-bottom: 10px;
        }

        .jieqi-status-container {
            margin-bottom: 10px;
        }

        .jieqi-status {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 13px;
            margin-bottom: 5px;
            line-height: 1.4;
        }

        .jieqi-status.today {
            background: linear-gradient(135deg, #4ECDC4, #44A08D);
            color: white;
            font-weight: bold;
        }

        .jieqi-status.upcoming {
            background: linear-gradient(135deg, #fff3cd, #ffeaa7);
            color: #856404;
        }

        .festival-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .festival-item {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 12px;
            color: #666;
        }

        .festival-item.jieqi {
            background: linear-gradient(135deg, #4ECDC4, #44A08D);
            color: white;
        }

        .festival-item.holiday {
            background: linear-gradient(135deg, #FF6B6B, #E6A23C);
            color: white;
        }

        .upcoming-section {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e9ecef;
        }

        .upcoming-title {
            font-size: 14px;
            font-weight: bold;
            color: #FF6B6B;
            margin-bottom: 10px;
        }

        .upcoming-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .upcoming-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, #fff3cd, #ffeaa7);
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 13px;
            transition: transform 0.2s ease;
        }

        .upcoming-item:hover {
            transform: translateX(5px);
        }

        .upcoming-name {
            color: #856404;
            font-weight: bold;
        }

        .upcoming-days {
            color: #d63384;
            font-weight: bold;
            background: rgba(255, 255, 255, 0.5);
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
        }

        /* èŠ‚å‡æ—¥æ ·å¼ */
        .holiday-section {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e9ecef;
        }

        .holiday-title {
            font-size: 14px;
            font-weight: bold;
            color: #5CB85C;
            margin-bottom: 10px;
        }

        .holiday-status {
            display: flex;
            align-items: center;
            padding: 10px;
            border-radius: 8px;
            font-size: 13px;
            line-height: 1.4;
        }

        .holiday-status.rest {
            background: linear-gradient(135deg, #5CB85C, #4CAE4C);
            color: white;
        }

        .holiday-status.work {
            background: linear-gradient(135deg, #E6A23C, #D68910);
            color: white;
        }

        .holiday-icon {
            font-size: 16px;
            margin-right: 8px;
        }

        .holiday-symbol {
            font-size: 18px;
            font-weight: bold;
            margin-right: 8px;
            background: rgba(255, 255, 255, 0.3);
            padding: 2px 6px;
            border-radius: 4px;
            min-width: 24px;
            text-align: center;
        }

        .holiday-name {
            font-weight: bold;
            margin-right: 8px;
        }

        .holiday-type {
            font-size: 12px;
            opacity: 0.9;
        }

        .weekstart-selector {
            display: flex;
            align-items: center;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            padding: 2px;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .weekstart-option {
            padding: 6px 12px;
            cursor: pointer;
            border-radius: 16px;
            font-size: 12px;
            color: rgba(255, 255, 255, 0.8);
            transition: all 0.3s ease;
            user-select: none;
            white-space: nowrap;
        }

        .weekstart-option.active {
            background: white;
            color: #2196F3;
            font-weight: bold;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .weekstart-option:hover:not(.active) {
            background: rgba(255, 255, 255, 0.1);
        }

        .yishen-container {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            gap: 10px;
        }

        #yi, #ji {
            flex: 2;
            margin: 0;
            padding: 8px 6px;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            min-height: 110px;
        }

        #jshen, #xshen {
            flex: 1;
            margin: 0;
            padding: 10px;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            min-height: 120px;
        }

        .yiji-content {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(30px, 1fr));
            gap: 2px;
            align-items: start;
            justify-items: center;
        }

        .shen-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 4px;
            align-items: start;
        }

        .yiji {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
        }

        .yiji b, #jshen b {
            color: #4ECDC4;
            font-size: 1rem;
            margin-right: 8px;
            display: block;
            margin-bottom: 6px;
            text-align: center;
        }

        .yiji.ji {
            background: linear-gradient(135deg, #ffe6e6, #ffcccc);
        }

        .yiji.ji b, #xshen b {
            color: #FF6B6B;
            font-size: 1rem;
            margin-right: 8px;
            display: block;
            margin-bottom: 6px;
            text-align: center;
        }

        .yiji i {
            color: #666;
            font-size: 10px;
            font-style: normal;
            text-align: center;
            padding: 2px 4px;
            background: rgba(255, 255, 255, 0.6);
            border-radius: 3px;
            border: 1px solid rgba(0, 0, 0, 0.1);
            white-space: nowrap;
            min-width: fit-content;
            max-width: 100%;
            box-sizing: border-box;
            line-height: 1.2;
        }

        .shen i {
            color: #666;
            font-size: 10px;
            font-style: normal;
            text-align: center;
            padding: 2px 3px;
            background: rgba(255, 255, 255, 0.6);
            border-radius: 3px;
            border: 1px solid rgba(0, 0, 0, 0.1);
            width: 100%;
            box-sizing: border-box;
            line-height: 1.2;
        }

        #jshen {
            background: linear-gradient(135deg, #f0f8ff, #e6f3ff);
        }

        #xshen {
            background: linear-gradient(135deg, #fff5f5, #ffe6e6);
        }

        @media (max-width: 1024px) {
            .main-container {
                flex-direction: column;
                align-items: center;
            }

            .detail-section {
                width: 100%;
                max-width: none;
            }
        }

        /* æ‰‹æœºç«¯ä¼˜åŒ– */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .main-container {
                padding: 15px;
                gap: 15px;
                border-radius: 15px;
            }

            .calendar-section {
                width: 100%;
            }

            .detail-section {
                min-width: auto;
                max-width: none;
            }

            /* æ—¥å†å¤´éƒ¨ä¼˜åŒ– */
            .calendar-header {
                flex-wrap: wrap;
                gap: 8px;
                padding: 12px;
                justify-content: center;
            }

            .nav-btn {
                padding: 6px 10px;
                font-size: 12px;
            }

            .today-btn {
                padding: 6px 10px;
            }

            /* æ—¥æœŸé€‰æ‹©å™¨åŒºåŸŸ - ä¸Šæœˆ/ä¸‹æœˆ/å¹´æœˆåœ¨åŒä¸€è¡Œ */
            .date-selector {
                display: flex;
                align-items: center;
                gap: 6px;
                flex-shrink: 0;
            }

            .mobile-prev-btn {
                padding: 6px 10px;
                font-size: 12px;
            }

            .year-input {
                width: 60px !important;
                min-width: 60px !important;
                font-size: 13px;
                padding: 5px 6px;
                text-align: center;
            }

            .month-select {
                font-size: 11px;
                padding: 5px 6px;
            }

            .mobile-next-btn {
                padding: 6px 10px;
                font-size: 12px;
            }

            /* éšè—åŸå§‹çš„ä¸Šæœˆä¸‹æœˆæŒ‰é’® */
            .nav-btn[onclick="changeMonth(-1)"]:not(.mobile-prev-btn),
            .nav-btn[onclick="changeMonth(1)"]:not(.mobile-next-btn) {
                display: none;
            }

            .today-btn {
                order: 1;
            }

            .festival-selector,
            .theme-selector,
            .weekstart-selector {
                order: 2;
            }

            /* æ˜ŸæœŸé€‰æ‹©å™¨ç®€åŒ– */
            .weekstart-selector {
                padding: 2px;
            }

            .weekstart-option {
                padding: 4px 8px;
                font-size: 11px;
            }

            /* æ—¥å†ç½‘æ ¼ä¼˜åŒ– */
            .calendar-grid {
                gap: 4px;
                padding: 10px;
                border-radius: 10px;
            }

            .weekday {
                padding: 8px 0;
                font-size: 12px;
            }

            .calendar-day {
                border-width: 1px;
                border-radius: 8px;
                padding: 0;
                aspect-ratio: 1;
                min-height: 40px;
            }

            .day-number {
                font-size: 14px;
                margin-bottom: 2px;
                line-height: 1.2;
            }

            .lunar-day {
                font-size: 9px;
                line-height: 1.1;
            }

            /* æ ‡ç­¾ä¼˜åŒ– - ç§»åŠ¨ç«¯èŠ‚æ—¥æ ‡ç­¾ç¼©å°ï¼Œé¿å…é®æŒ¡æ—¥æœŸ */
            .festival-tag {
                font-size: 2px;
                padding: 0;
                top: 1px;
                max-width: calc(100% - 4px);
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
                transform: translateX(-50%);
                left: 50%;
                right: auto;
                border-radius: 3px;
                line-height: 1;
                min-height: 8px;
                background: transparent;
                z-index: 1; /* èŠ‚æ—¥æ ‡ç­¾å±‚çº§æ›´ä½ */
            }

            .day-number {
                position: relative;
                z-index: 2; /* æ—¥æœŸæ•°å­—å±‚çº§æ›´é«˜ */
            }

            .jieqi-tag,
            .fu-jiu-tag {
                display: none;
            }

            /* æ‰‹æœºç«¯ä¼‘å‡ç”¨å°åœ†ç‚¹æ˜¾ç¤º */
            .holiday-tag {
                width: 7px;
                height: 7px;
                border-radius: 50%;
                padding: 0;
                font-size: 0;
                top: 2px;
                right: 2px;
            }

            .holiday-tag.rest {
                background: #5CB85C;
            }

            .holiday-tag.work {
                background: #E6A23C;
            }

            /* é»„å†è¯¦æƒ…é¢æ¿ä¼˜åŒ– */
            #detailPanel {
                padding: 12px;
            }

            .solar-date {
                font-size: 13px;
            }

            .nayin b, .chongsha b, .pengzu b {
                font-size: 11px;
            }

            .nayin i, .chongsha i, .pengzu i {
                font-size: 10px;
            }

            #yi, #ji, #jshen, #xshen {
                min-height: auto;
                padding: 6px;
            }

            .yiji i, .shen i {
                font-size: 9px;
            }

            /* æç¤ºæ¡†ä¼˜åŒ– */
            .date-tooltip {
                position: fixed;
                left: 10px !important;
                right: 10px !important;
                bottom: 10px !important;
                top: auto !important;
                max-width: none !important;
                min-width: auto !important;
                padding: 15px;
            }

            .tooltip-header {
                margin-bottom: 10px;
            }

            .tooltip-date {
                font-size: 16px;
            }

            .tooltip-lunar {
                font-size: 12px;
            }

            /* ç©ºçŠ¶æ€ä¼˜åŒ– */
            .empty-state {
                padding: 20px 10px;
                font-size: 13px;
            }

            /* èŠ‚æ—¥å’Œä¸»é¢˜ä¸‹æ‹‰èœå•ä¼˜åŒ– */
            .festival-dropdown,
            .theme-dropdown {
                position: fixed;
                left: 10px;
                right: 10px;
                width: auto;
                min-width: auto;
                max-width: none;
                top: 50%;
                transform: translateY(-50%);
            }
        }

        /* è¶…å°å±å¹•ä¼˜åŒ– */
        @media (max-width: 360px) {
            .main-container {
                padding: 10px;
            }

            .calendar-day {
                min-height: 35px;
            }

            .day-number {
                font-size: 12px;
            }

            .lunar-day {
                font-size: 8px;
            }

            .festival-tag,
            .jieqi-tag,
            .holiday-tag,
            .fu-jiu-tag {
                display: none;
            }
        }
        body.dark-theme {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        }

        body.dark-theme .main-container {
            background: rgba(30, 30, 46, 0.95);
            color: #e0e0e0;
        }

        body.dark-theme .calendar-header {
            background: linear-gradient(135deg, #2196F3, #1976D2);
        }

        body.dark-theme .nav-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
        }

        body.dark-theme .nav-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        body.dark-theme .year-input, 
        body.dark-theme .month-select {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
        }

        body.dark-theme .year-input:focus, 
        body.dark-theme .month-select:focus {
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 255, 255, 0.4);
        }

        body.dark-theme .calendar-grid {
            background: rgba(30, 30, 46, 0.8);
        }

        body.dark-theme .calendar-day {
            background: rgba(50, 50, 70, 0.8);
            border: 2px solid #4a5568;
            color: #e0e0e0;
        }

        body.dark-theme .calendar-day:hover {
            border-color: #2196F3;
            box-shadow: 0 5px 15px rgba(33, 150, 243, 0.3);
        }

        body.dark-theme .calendar-day.weekend:hover {
            border-color: #b8860b;
            box-shadow: 0 5px 15px rgba(184, 134, 11, 0.3);
        }

        body.dark-theme .calendar-day.selected {
            background: linear-gradient(135deg, #2196F3, #1976D2);
            border-color: #2196F3;
        }

        body.dark-theme .calendar-day.today {
            background: linear-gradient(135deg, #FF6B6B, #E6A23C);
            border-color: #FF6B6B;
        }

        body.dark-theme .calendar-day.weekend {
            background: linear-gradient(135deg, #3d3220, #4a3920);
            border-color: #b8860b;
        }

        body.dark-theme .weekday {
            color: #2196F3;
            border-bottom-color: #2196F3;
        }

        body.dark-theme .lunar-day {
            color: #a0a0a0;
        }

        body.dark-theme .date-tooltip {
            background: rgba(30, 30, 46, 0.98);
            border: 1px solid #4a5568;
            color: #e0e0e0;
        }

        body.dark-theme .tooltip-date-info {
            background: linear-gradient(135deg, #2d3748, #1a202c);
            border-left-color: #2196F3;
        }

        body.dark-theme .info-label {
            color: #a0a0a0;
        }

        body.dark-theme .info-value {
            color: #2196F3;
            background: rgba(33, 150, 243, 0.1);
        }

        body.dark-theme .huangli {
            background: rgba(30, 30, 46, 0.9);
            color: #e0e0e0;
        }

        body.dark-theme .solar-date {
            background: linear-gradient(135deg, #1e3a8a, #1e40af);
            color: white;
            border-left-color: #2196F3;
        }

        body.dark-theme .yiji {
            background: linear-gradient(135deg, #2d3748, #1a202c);
        }

        body.dark-theme .yiji.ji {
            background: linear-gradient(135deg, #4a1a1a, #2d1818);
        }

        body.dark-theme .yiji i,
        body.dark-theme .shen i {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #a0a0a0;
        }

        body.dark-theme .festival-dropdown,
        body.dark-theme .theme-dropdown {
            background: #2d3748;
            border: 1px solid #4a5568;
        }

        body.dark-theme .festival-option,
        body.dark-theme .theme-option {
            color: #e0e0e0;
        }

        body.dark-theme .festival-option:hover,
        body.dark-theme .theme-option:hover {
            background-color: #4a5568;
        }

        body.dark-theme .festival-option span,
        body.dark-theme .theme-option span {
            color: #e0e0e0;
        }

        /* ä¸»é¢˜åˆ‡æ¢åŠ¨ç”» */
        body {
            transition: background 0.3s ease;
        }

        .main-container,
        .calendar-day,
        .date-tooltip,
        .huangli,
        .tooltip-date-info,
        .yiji,
        .festival-dropdown,
        .theme-dropdown {
            transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
        }

        @media (max-width: 768px) {
            .main-container {
                padding: 20px;
                gap: 20px;
            }

            .calendar-grid {
                gap: 5px;
                padding: 15px;
            }

            .day-number {
                font-size: 16px;
            }

            .detail-panel {
                padding: 20px;
            }

            /* æç¤ºæ¶ˆæ¯æ ·å¼ */
            .toast-message {
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: rgba(0, 0, 0, 0.8);
                color: white;
                padding: 12px 24px;
                border-radius: 8px;
                font-size: 14px;
                z-index: 9999;
                animation: toastFade 0.3s ease;
            }

            @keyframes toastFade {
                from { opacity: 0; transform: translate(-50%, -50%) scale(0.9); }
                to { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            }
        }
    </style>
</head>
<body>
    <div class="main-container">
        <section class="calendar-section">
            <div class="calendar-header">
                <button class="nav-btn mobile-prev-btn" onclick="changeMonth(-1)">ä¸Šæœˆ</button>
                <div class="date-selector">
                    <input type="number" class="year-input" id="yearInput" placeholder="å¹´ä»½" min="1900" max="2100" onchange="updateCalendar()">
                    <select class="month-select" id="monthSelect" onchange="updateCalendar()">
                        <option value="1">ä¸€æœˆ</option>
                        <option value="2">äºŒæœˆ</option>
                        <option value="3">ä¸‰æœˆ</option>
                        <option value="4">å››æœˆ</option>
                        <option value="5">äº”æœˆ</option>
                        <option value="6">å…­æœˆ</option>
                        <option value="7">ä¸ƒæœˆ</option>
                        <option value="8">å…«æœˆ</option>
                        <option value="9">ä¹æœˆ</option>
                        <option value="10">åæœˆ</option>
                        <option value="11">åä¸€æœˆ</option>
                        <option value="12">åäºŒæœˆ</option>
                    </select>
                </div>
                <button class="nav-btn mobile-next-btn" onclick="changeMonth(1)">ä¸‹æœˆ</button>
                <div class="festival-selector">
                    <button class="nav-btn festival-toggle" onclick="toggleFestivalSelector()">èŠ‚æ—¥</button>
                    <div class="festival-dropdown" id="festivalDropdown">
                        <label class="festival-option">
                            <input type="checkbox" id="showSolarFestivals" onchange="updateFestivalSettings()" checked>
                            <span>é˜³å†èŠ‚æ—¥</span>
                        </label>
                        <label class="festival-option">
                            <input type="checkbox" id="showLunarFestivals" onchange="updateFestivalSettings()" checked>
                            <span>å†œå†èŠ‚æ—¥</span>
                        </label>
                        <label class="festival-option">
                            <input type="checkbox" id="showJieqi" onchange="updateFestivalSettings()" checked>
                            <span>èŠ‚æ°”</span>
                        </label>
                        <label class="festival-option">
                            <input type="checkbox" id="showWeekFestivals" onchange="updateFestivalSettings()" checked>
                            <span>æ˜ŸæœŸèŠ‚æ—¥</span>
                        </label>
                        <label class="festival-option">
                            <input type="checkbox" id="showOtherFestivals" onchange="updateFestivalSettings()">
                            <span>å…¶ä»–èŠ‚æ—¥</span>
                        </label>
                    </div>
                </div>
                <div class="weekstart-selector">
                    <div class="weekstart-option active" data-value="1" onclick="toggleWeekStart(1)">å‘¨ä¸€</div>
                    <div class="weekstart-option" data-value="0" onclick="toggleWeekStart(0)">å‘¨æ—¥</div>
                </div>
                <div class="theme-selector">
                    <button class="nav-btn theme-toggle" onclick="toggleThemeSelector()">ä¸»é¢˜</button>
                    <div class="theme-dropdown" id="themeDropdown">
                        <div class="theme-option" data-theme="light" onclick="setTheme('light')">
                            <span class="theme-icon">â˜€ï¸</span>
                            <span>æµ…è‰²æ¨¡å¼</span>
                        </div>
                        <div class="theme-option" data-theme="dark" onclick="setTheme('dark')">
                            <span class="theme-icon">ğŸŒ™</span>
                            <span>æ·±è‰²æ¨¡å¼</span>
                        </div>
                        <div class="theme-option" data-theme="system" onclick="setTheme('system')">
                            <span class="theme-icon">ğŸ’»</span>
                            <span>è·Ÿéšç³»ç»Ÿ</span>
                        </div>
                    </div>
                </div>
                <button class="nav-btn today-btn" onclick="goToToday()">ä»Šå¤©</button>
            </div>
            <div class="calendar-grid" id="calendarGrid">
                <!-- æ˜ŸæœŸæ ‡é¢˜ -->
                <div class="weekday">æ—¥</div>
                <div class="weekday">ä¸€</div>
                <div class="weekday">äºŒ</div>
                <div class="weekday">ä¸‰</div>
                <div class="weekday">å››</div>
                <div class="weekday">äº”</div>
                <div class="weekday">å…­</div>
                <!-- æ—¥æœŸå°†é€šè¿‡JavaScriptç”Ÿæˆ -->
            </div>
        </section>

        <aside class="detail-section">
            <div id="detailPanel" class="huangli">
                <div class="empty-state">
                    <p>ğŸ“… æ­£åœ¨åŠ è½½é»„å†ä¿¡æ¯...</p>
                    <p style="margin-top: 10px; font-size: 14px;">è¯·ç¨å€™</p>
                </div>
            </div>
        </aside>
    </div>

    <!-- æ—¥æœŸæç¤ºæ¡† -->
    <div id="dateTooltip" class="date-tooltip">
        <div class="tooltip-header">
            <div>
                <div class="tooltip-date" id="tooltipSolarDate"></div>
                <div class="tooltip-lunar" id="tooltipLunarDate"></div>
            </div>
        </div>
        
        <!-- æ—¥æœŸè®¡ç®—ä¿¡æ¯ -->
        <div class="tooltip-date-info" id="tooltipDateInfo" style="display: none;">
            <div class="date-info-row">
                <div class="date-info-item">
                    <span class="info-label">ç¬¬</span>
                    <span class="info-value" id="tooltipWeekOfYear"></span>
                    <span class="info-label">å‘¨/å‰©</span>
                    <span class="info-value" id="tooltipWeeksRemaining"></span>
                    <span class="info-label">å‘¨</span>
                </div>
                <div class="date-info-item">
                    <span class="info-label">å…±</span>
                    <span class="info-value" id="tooltipTotalWeeks"></span>
                    <span class="info-label">å‘¨</span>
                </div>
            </div>
            <div class="date-info-row">
                <div class="date-info-item">
                    <span class="info-label">ç¬¬</span>
                    <span class="info-value" id="tooltipDayOfYear"></span>
                    <span class="info-label">å¤©/å‰©</span>
                    <span class="info-value" id="tooltipDaysRemaining"></span>
                    <span class="info-label">å¤©</span>
                </div>
                <div class="date-info-item">
                    <span class="info-label">å…±</span>
                    <span class="info-value" id="tooltipTotalDays"></span>
                    <span class="info-label">å¤©</span>
                </div>
            </div>
            <div class="date-info-item">
                <span class="info-label">ä¸‹ä¸ªèŠ‚æ—¥ï¼š</span>
                <span class="info-value" id="tooltipNextFestival"></span>
            </div>
        </div>
        
        <div id="tooltipJieqi" class="tooltip-jieqi" style="display: none;">
            <img id="tooltipJieqiImg" src="" alt="">
            <div class="tooltip-jieqi-info">
                <div class="tooltip-jieqi-name" id="tooltipJieqiName"></div>
                <div class="tooltip-jieqi-desc" id="tooltipJieqiDesc"></div>
            </div>
        </div>
        <div id="tooltipFuJiu" class="tooltip-fu-jiu" style="display: none;">
            <div class="tooltip-fu-jiu-title">ä¼ ç»ŸèŠ‚æ°”</div>
            <div class="tooltip-fu-jiu-content">
                <div id="tooltipFu"></div>
                <div id="tooltipJiu"></div>
            </div>
        </div>
        <div id="tooltipHoliday" class="tooltip-holiday" style="display: none;">
            <span class="tooltip-holiday-symbol" id="tooltipHolidaySymbol"></span>
            <span class="tooltip-holiday-name" id="tooltipHolidayName"></span>
        </div>
        <div id="tooltipFestivals" class="tooltip-festivals" style="display: none;">
            <div class="tooltip-festival-title">èŠ‚æ—¥</div>
            <div class="tooltip-festival-list" id="tooltipFestivalList"></div>
        </div>
    </div>

    <script>
        // å…¨å±€çŠ¶æ€
        const state = {
            currentDate: new Date(),
            selectedDate: null,
            currentYear: new Date().getFullYear(),
            currentMonth: new Date().getMonth() + 1,
            weekStart: 0, // 0=å‘¨æ—¥å¼€å§‹, 1=å‘¨ä¸€å¼€å§‹
            festivalSettings: {
                showSolarFestivals: true,   // é˜³å†èŠ‚æ—¥
                showLunarFestivals: true,   // å†œå†èŠ‚æ—¥
                showJieqi: true,            // èŠ‚æ°”
                showOtherFestivals: false,  // å…¶ä»–èŠ‚æ—¥ï¼ˆé“æ•™ã€ä½›æ•™ç­‰ï¼‰
                showWeekFestivals: true     // æŒ‰æ˜ŸæœŸçš„èŠ‚æ—¥
            }
        };

        // èŠ‚æ°”æ•°æ®
        const jieqiData = {
            'ç«‹æ˜¥': '#4ECDC4', 'é›¨æ°´': '#4ECDC4', 'æƒŠè›°': '#4ECDC4', 'æ˜¥åˆ†': '#4ECDC4',
            'æ¸…æ˜': '#4ECDC4', 'è°·é›¨': '#4ECDC4', 'ç«‹å¤': '#FF6B6B', 'å°æ»¡': '#FF6B6B',
            'èŠ’ç§': '#FF6B6B', 'å¤è‡³': '#FF6B6B', 'å°æš‘': '#FF6B6B', 'å¤§æš‘': '#FF6B6B',
            'ç«‹ç§‹': '#E6A23C', 'å¤„æš‘': '#E6A23C', 'ç™½éœ²': '#E6A23C', 'ç§‹åˆ†': '#E6A23C',
            'å¯’éœ²': '#E6A23C', 'éœœé™': '#E6A23C', 'ç«‹å†¬': '#764ba2', 'å°é›ª': '#764ba2',
            'å¤§é›ª': '#764ba2', 'å†¬è‡³': '#764ba2', 'å°å¯’': '#764ba2', 'å¤§å¯’': '#764ba2'
        };

        // èŠ‚æ°”æè¿°ä¿¡æ¯
        const jieqiDesc = {
            'ç«‹æ˜¥': 'æ˜¥å­£å¼€å§‹ï¼Œä¸‡ç‰©å¤è‹ï¼Œå¤©æ°”æ¸æš–',
            'é›¨æ°´': 'é™é›¨å¼€å§‹ï¼Œé›¨é‡æ¸å¢ï¼Œæ˜¥æ„ç›ç„¶',
            'æƒŠè›°': 'æ˜¥é›·å§‹é¸£ï¼Œè›°è™«æƒŠé†’ï¼Œç”Ÿæœºå‹ƒå‹ƒ',
            'æ˜¥åˆ†': 'æ˜¼å¤œå¹³åˆ†ï¼Œæ˜¥æš–èŠ±å¼€ï¼Œæ’­ç§æ—¶èŠ‚',
            'æ¸…æ˜': 'å¤©æ°”æ¸…æœ—ï¼Œè‰æœ¨ç¹èŒ‚ï¼Œæ‰«å¢“ç¥­ç¥–',
            'è°·é›¨': 'é›¨ç”Ÿç™¾è°·ï¼Œä½œç‰©ç”Ÿé•¿ï¼Œæ˜¥è€•å¿™ç¢Œ',
            'ç«‹å¤': 'å¤å­£å¼€å§‹ï¼Œæ°”æ¸©å‡é«˜ï¼Œä¸‡ç‰©ç”Ÿé•¿',
            'å°æ»¡': 'éº¦ç±»ç­‰å¤ç†Ÿä½œç‰©ç±½ç²’å¼€å§‹é¥±æ»¡',
            'èŠ’ç§': 'æœ‰èŠ’ä½œç‰©æˆç†Ÿï¼Œæ™šè°·æ’­ç§æ—¶èŠ‚',
            'å¤è‡³': 'ç™½æ˜¼æœ€é•¿ï¼Œç››å¤æ¥ä¸´ï¼Œç‚çƒ­å¼€å§‹',
            'å°æš‘': 'å¤©æ°”å¼€å§‹ç‚çƒ­ï¼Œä½†è¿˜æœªåˆ°æœ€çƒ­',
            'å¤§æš‘': 'ä¸€å¹´ä¸­æœ€çƒ­çš„æ—¶æœŸï¼Œé…·çƒ­éš¾è€',
            'ç«‹ç§‹': 'ç§‹å­£å¼€å§‹ï¼Œå¤©æ°”è½¬å‡‰ï¼Œæ”¶è·æ—¶èŠ‚',
            'å¤„æš‘': 'ç‚çƒ­å¤©æ°”ç»“æŸï¼Œæš‘æ°”æ¶ˆé€€',
            'ç™½éœ²': 'å¤©æ°”è½¬å‡‰ï¼Œéœ²æ°´å‡ç»“ï¼Œç§‹æ„æ¸æµ“',
            'ç§‹åˆ†': 'æ˜¼å¤œå¹³åˆ†ï¼Œç§‹é«˜æ°”çˆ½ï¼Œä¸°æ”¶å­£èŠ‚',
            'å¯’éœ²': 'éœ²æ°´å·²å¯’ï¼Œæ°”æ¸©ä¸‹é™ï¼Œç§‹æ·±éœ²é‡',
            'éœœé™': 'å¤©æ°”æ¸å†·ï¼Œå¼€å§‹é™éœœï¼Œç§‹å»å†¬æ¥',
            'ç«‹å†¬': 'å†¬å­£å¼€å§‹ï¼Œä¸‡ç‰©æ”¶è—ï¼Œå¤©æ°”å¯’å†·',
            'å°é›ª': 'å¼€å§‹é™é›ªï¼Œä½†é›ªé‡ä¸å¤§',
            'å¤§é›ª': 'é™é›ªå¢å¤šï¼Œåœ°é¢å¯èƒ½ç§¯é›ª',
            'å†¬è‡³': 'ç™½æ˜¼æœ€çŸ­ï¼Œé»‘å¤œæœ€é•¿ï¼Œæ•°ä¹å¼€å§‹',
            'å°å¯’': 'å¤©æ°”å¯’å†·ï¼Œä½†è¿˜æœªåˆ°æœ€å†·',
            'å¤§å¯’': 'ä¸€å¹´ä¸­æœ€å†·çš„æ—¶æœŸï¼Œä¸¥å¯’åˆºéª¨'
        };

        // èŠ‚æ°”å›¾ç‰‡è·¯å¾„é…ç½®
        const JIEQI_IMAGE_PATH = 'imgs/';
        
        // èŠ‚æ°”å›¾ç‰‡æ–‡ä»¶åæ˜ å°„
        const jieqiImageFiles = {
            'ç«‹æ˜¥': 'li_chun.webp',
            'é›¨æ°´': 'yu_shui.webp',
            'æƒŠè›°': 'jing_zhe.webp',
            'æ˜¥åˆ†': 'chun_fen.webp',
            'æ¸…æ˜': 'qing_ming.webp',
            'è°·é›¨': 'gu_yu.webp',
            'ç«‹å¤': 'li_xia.webp',
            'å°æ»¡': 'xiao_man.webp',
            'èŠ’ç§': 'mang_zhong.webp',
            'å¤è‡³': 'xia_zhi.webp',
            'å°æš‘': 'xiao_shu.webp',
            'å¤§æš‘': 'da_shu.webp',
            'ç«‹ç§‹': 'li_qiu.webp',
            'å¤„æš‘': 'chu_shu.webp',
            'ç™½éœ²': 'bai_lu.webp',
            'ç§‹åˆ†': 'qiu_fen.webp',
            'å¯’éœ²': 'han_lu.webp',
            'éœœé™': 'shuang_jiang.webp',
            'ç«‹å†¬': 'li_dong.webp',
            'å°é›ª': 'xiao_xue.webp',
            'å¤§é›ª': 'da_xue.webp',
            'å†¬è‡³': 'dong_zhi.webp',
            'å°å¯’': 'xiao_han.webp',
            'å¤§å¯’': 'da_han.webp'
        };
        
        // è·å–èŠ‚æ°”å®Œæ•´å›¾ç‰‡è·¯å¾„çš„å‡½æ•°
        function getJieqiImagePath(jieqiName) {
            const fileName = jieqiImageFiles[jieqiName];
            return fileName ? JIEQI_IMAGE_PATH + fileName : '';
        }

        // åˆå§‹åŒ–æ—¥å†
        function init() {
            // æ£€æŸ¥lunar.jsæ˜¯å¦åŠ è½½å®Œæˆ
            if (typeof Solar === 'undefined') {
                console.error('lunar.js æœªåŠ è½½å®Œæˆ');
                return;
            }
            initializeSelectors();
            initializeWeekStartSettings();
            initializeFestivalSettings();
            initializeThemeSettings();
            renderCalendar();
            // é»˜è®¤æ˜¾ç¤ºä»Šå¤©çš„é»„å†ä¿¡æ¯
            showToday();
            
            // è‡ªåŠ¨æ£€æŸ¥å½“å‰æœˆä»½æ˜¯å¦æœ‰ä¸‰ä¹ä¿¡æ¯å¹¶ç»™å‡ºæç¤º
            setTimeout(checkFuJiuInfo, 1000);
        }
        
        // æ‰‹åŠ¨è®¡ç®—ä¸‰ä¹ä¿¡æ¯
        function calculateManualJiuInfo(solar) {
            try {
                // è·å–å†¬è‡³æ—¥æœŸ
                const dongzhi = Lunar.fromYmd(solar.getYear(), 12, 1).getJieQiTable()['å†¬è‡³'];
                if (!dongzhi) return null;
                
                // è·å–å†¬è‡³æ—¥æœŸï¼ˆå…¼å®¹ä¸åŒç‰ˆæœ¬ï¼‰
                let dongzhiDate;
                if (typeof dongzhi.getSolar === 'function') {
                    dongzhiDate = dongzhi.getSolar();
                } else if (dongzhi.getYear && dongzhi.getMonth && dongzhi.getDay) {
                    dongzhiDate = Solar.fromYmd(dongzhi.getYear(), dongzhi.getMonth(), dongzhi.getDay());
                } else {
                    return null;
                }
                
                // è®¡ç®—ä»å†¬è‡³å¼€å§‹çš„å¤©æ•°
                const daysAfterDongzhi = solar.subtract(dongzhiDate);
                
                // å¦‚æœå¤©æ•°å°äº0ï¼Œè¯´æ˜åœ¨å†¬è‡³å‰ï¼Œæ²¡æœ‰ä¸‰ä¹ä¿¡æ¯
                if (daysAfterDongzhi < 0) return null;
                
                // è®¡ç®—å±äºç¬¬å‡ ä¸ªä¹å¤©
                const jiuNumber = Math.floor(daysAfterDongzhi / 9) + 1;
                
                // ä¸‰ä¹å…±9ä¸ªä¹å¤©ï¼Œè¶…è¿‡81å¤©åˆ™æ²¡æœ‰ä¸‰ä¹ä¿¡æ¯
                if (jiuNumber > 9) return null;
                
                // è¿”å›ä¸‰ä¹ä¿¡æ¯
                const jiuNames = ['ä¸€ä¹', 'äºŒä¹', 'ä¸‰ä¹', 'å››ä¹', 'äº”ä¹', 'å…­ä¹', 'ä¸ƒä¹', 'å…«ä¹', 'ä¹ä¹'];
                const currentDayInJiu = daysAfterDongzhi % 9 + 1;
                
                return {
                    jiu: jiuNames[jiuNumber - 1],
                    dayInJiu: currentDayInJiu,
                    fullText: `${jiuNames[jiuNumber - 1]}ç¬¬${currentDayInJiu}å¤©`
                };
                
            } catch (error) {
                console.warn('æ‰‹åŠ¨è®¡ç®—ä¸‰ä¹ä¿¡æ¯å¤±è´¥:', error);
                return null;
            }
        }

        // æ£€æŸ¥å½“å‰æœˆä»½ä¸‰ä¹ä¿¡æ¯å¹¶ç»™å‡ºæ™ºèƒ½æç¤º
        function checkFuJiuInfo() {
            if (typeof Solar === 'undefined') return;
            
            const daysInMonth = SolarUtil.getDaysOfMonth(state.currentYear, state.currentMonth);
            let hasFuJiu = false;
            
            for (let day = 1; day <= daysInMonth; day++) {
                try {
                    const solar = Solar.fromYmd(state.currentYear, state.currentMonth, day);
                    const lunar = solar.getLunar();
                    
                    // è°ƒè¯•ä¿¡æ¯
                    console.log(`${state.currentYear}-${state.currentMonth}-${day} ä¸‰ä¹ä¿¡æ¯æ£€æŸ¥:`);
                    
                    // æ£€æŸ¥ä¸‰ä¼
                    if (lunar.getFu) {
                        const fu = lunar.getFu();
                        console.log('ä¸‰ä¼:', fu);
                        if (fu) {
                            hasFuJiu = true;
                            break;
                        }
                    }
                    
                    // æ£€æŸ¥ä¸‰ä¹ï¼ˆä½¿ç”¨æ–°çš„getShuJiuæ–¹æ³•ï¼‰
                    if (lunar.getShuJiu) {
                        const shuJiu = lunar.getShuJiu();
                        console.log('æ•°ä¹å¯¹è±¡:', shuJiu);
                        if (shuJiu) {
                            console.log('æ•°ä¹åç§°:', shuJiu.getName());
                            console.log('æ•°ä¹å¤©æ•°:', shuJiu.getIndex());
                            hasFuJiu = true;
                            break;
                        }
                    }
                    
                    // å…¼å®¹æ—§çš„ä¸‰ä¹æ–¹æ³•
                    if (lunar.getJiu) {
                        const jiu = lunar.getJiu();
                        console.log('ä¸‰ä¹:', jiu);
                        if (jiu) {
                            hasFuJiu = true;
                            break;
                        }
                    }
                    
                    // å°è¯•å…¶ä»–å¯èƒ½çš„ä¸‰ä¹ä¿¡æ¯è·å–æ–¹æ³•
                    console.log('lunarå¯¹è±¡å±æ€§:', Object.keys(lunar));
                    
                    // æ£€æŸ¥æ˜¯å¦æœ‰å…¶ä»–ä¸‰ä¹ç›¸å…³å±æ€§
                    if (lunar.fu) {
                        console.log('ä¸‰ä¼(å±æ€§):', lunar.fu);
                    }
                    if (lunar.jiu) {
                        console.log('ä¸‰ä¹(å±æ€§):', lunar.jiu);
                    }
                    
                    // æ£€æŸ¥èŠ‚æ°”ä¿¡æ¯ï¼Œçœ‹æ˜¯å¦åŒ…å«ä¸‰ä¹
                    const jieQi = lunar.getJieQi();
                    console.log('èŠ‚æ°”:', jieQi);
                    
                    // æ£€æŸ¥èŠ‚æ°”è¡¨
                    const jieQiTable = lunar.getJieQiTable ? lunar.getJieQiTable() : {};
                    console.log('èŠ‚æ°”è¡¨:', jieQiTable);
                    
                    // æ‰‹åŠ¨è®¡ç®—ä¸‰ä¹ä¿¡æ¯
                    const manualJiuInfo = calculateManualJiuInfo(solar);
                    console.log('æ‰‹åŠ¨è®¡ç®—ä¸‰ä¹ä¿¡æ¯:', manualJiuInfo);
                    if (manualJiuInfo) {
                        hasFuJiu = true;
                        break;
                    }
                } catch (error) {
                    console.warn(`è·å–${state.currentYear}å¹´${state.currentMonth}æœˆ${day}æ—¥ä¿¡æ¯å¤±è´¥:`, error);
                    continue;
                }
            }
            
            if (!hasFuJiu) {
                // æ ¹æ®å½“å‰æœˆä»½ç»™å‡ºæ™ºèƒ½æç¤º
                let message = '';
                const currentMonth = state.currentMonth;
                
                if (currentMonth >= 1 && currentMonth <= 2) {
                    message = 'å½“å‰æ˜¯å†¬å­£ï¼Œä½†æœªæ£€æµ‹åˆ°ä¸‰ä¹ä¿¡æ¯ã€‚\nä¸‰ä¹é€šå¸¸ä»å†¬è‡³åå¼€å§‹ï¼Œå»ºè®®æ£€æŸ¥å½“å‰å¹´ä»½çš„å†¬è‡³æ—¥æœŸã€‚';
                } else if (currentMonth >= 12) {
                    message = 'å½“å‰æ˜¯å†¬å­£ï¼Œä½†æœªæ£€æµ‹åˆ°ä¸‰ä¹ä¿¡æ¯ã€‚\nä¸‰ä¹é€šå¸¸ä»å†¬è‡³åå¼€å§‹ï¼Œå»ºè®®æ£€æŸ¥å½“å‰å¹´ä»½çš„å†¬è‡³æ—¥æœŸã€‚';
                } else if (currentMonth >= 6 && currentMonth <= 8) {
                    message = 'å½“å‰æ˜¯å¤å­£ï¼Œå¯ä»¥æŸ¥çœ‹ä¸‰ä¼ä¿¡æ¯ã€‚\nä¸‰ä¹ä¿¡æ¯é€šå¸¸åœ¨å†¬å­£ï¼ˆ12æœˆ-2æœˆï¼‰å‡ºç°ã€‚';
                } else {
                    message = 'å½“å‰æœˆä»½ä¸æ˜¯ä¸‰ä¹æˆ–ä¸‰ä¼çš„å­£èŠ‚ã€‚\nä¸‰ä¹ä¿¡æ¯é€šå¸¸åœ¨å†¬å­£ï¼ˆ12æœˆ-2æœˆï¼‰å‡ºç°ã€‚';
                }
                
                // æ£€æŸ¥å†¬è‡³æ—¥æœŸ
                try {
                    const dongzhi = Lunar.fromYmd(state.currentYear, 12, 1).getJieQiTable()['å†¬è‡³'];
                    if (dongzhi) {
                        // å°è¯•ä¸åŒçš„è·å–æ–¹å¼
                        let dongzhiDate;
                        if (typeof dongzhi.getSolar === 'function') {
                            dongzhiDate = dongzhi.getSolar();
                        } else if (dongzhi.toString) {
                            dongzhiDate = dongzhi.toString();
                        } else {
                            dongzhiDate = dongzhi;
                        }
                        message += `\n\n${state.currentYear}å¹´å†¬è‡³ï¼š${dongzhiDate}`;
                        message += '\næ•°ä¹ä»å†¬è‡³åå¼€å§‹ï¼Œå…±81å¤©ã€‚';
                    }
                } catch (error) {
                    console.warn('è·å–å†¬è‡³ä¿¡æ¯å¤±è´¥:', error);
                }
                
                console.log('ä¸‰ä¹ä¿¡æ¯æç¤ºï¼š', message);
                
                // åœ¨é¡µé¢åº•éƒ¨æ˜¾ç¤ºæç¤ºä¿¡æ¯
                const infoDiv = document.createElement('div');
                infoDiv.className = 'fu-jiu-hint';
                infoDiv.innerHTML = `
                    <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 5px; padding: 10px; margin: 10px 0; font-size: 12px; color: #856404;">
                        <strong>ğŸ“… ä¸‰ä¹ä¿¡æ¯æç¤ºï¼š</strong> ${message.replace(/\\n/g, '<br>')}
                        <br><button onclick="this.parentElement.parentElement.remove()" style="margin-left: 10px; background: #ffc107; border: none; padding: 2px 8px; border-radius: 3px; cursor: pointer;">å…³é—­</button>
                    </div>
                `;
                
                const calendarDiv = document.getElementById('calendar');
                if (calendarDiv) {
                    calendarDiv.appendChild(infoDiv);
                }
            }
        }

        // æ˜¾ç¤ºä»Šå¤©çš„é»„å†ä¿¡æ¯
        function showToday() {
            const today = new Date();
            state.selectedDate = today;
            showDetail(today);
            
            // é€‰ä¸­ä»Šå¤©çš„æ—¥æœŸ
            setTimeout(() => {
                document.querySelectorAll('.calendar-day').forEach(el => {
                    el.classList.remove('selected');
                    if (el.classList.contains('today')) {
                        el.classList.add('selected');
                    }
                });
            }, 100);
        }

        // åˆå§‹åŒ–é€‰æ‹©å™¨
        function initializeSelectors() {
            const yearInput = document.getElementById('yearInput');
            const monthSelect = document.getElementById('monthSelect');
            
            // è®¾ç½®å½“å‰é€‰ä¸­çš„å¹´æœˆ
            if (yearInput) yearInput.value = state.currentYear;
            if (monthSelect) monthSelect.value = state.currentMonth;
            
            // æ·»åŠ å›è½¦é”®ç›‘å¬
            if (yearInput) {
                yearInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        updateCalendar();
                    }
                });
            }
        }

        // æ¸²æŸ“æ—¥å†
        function renderCalendar() {
            updateHeader();
            renderCalendarGrid();
        }

        // æ›´æ–°å¤´éƒ¨
        function updateHeader() {
            const yearInput = document.getElementById('yearInput');
            const monthSelect = document.getElementById('monthSelect');
            
            // åŒæ­¥é€‰æ‹©å™¨çŠ¶æ€
            if (yearInput) yearInput.value = state.currentYear;
            if (monthSelect) monthSelect.value = state.currentMonth;
        }

        // æ›´æ–°æ—¥å†ï¼ˆä»é€‰æ‹©å™¨è°ƒç”¨ï¼‰
        function updateCalendar() {
            const yearInput = document.getElementById('yearInput');
            const monthSelect = document.getElementById('monthSelect');
            
            if (yearInput && monthSelect) {
                const year = parseInt(yearInput.value);
                const month = parseInt(monthSelect.value);
                
                // éªŒè¯å¹´ä»½èŒƒå›´
                if (year && year >= 1900 && year <= 2100 && month >= 1 && month <= 12) {
                    state.currentYear = year;
                    state.currentMonth = month;
                    renderCalendar();
                    // æ¸…ç©ºè¯¦æƒ…é¢æ¿
                    const detailPanel = document.getElementById('detailPanel');
                    if (detailPanel) {
                        detailPanel.innerHTML = '<div class="empty-state"><p>è¯·é€‰æ‹©æ—¥æœŸæŸ¥çœ‹é»„å†ä¿¡æ¯</p></div>';
                    }
                } else {
                    // æ¢å¤æœ‰æ•ˆå€¼
                    yearInput.value = state.currentYear;
                    monthSelect.value = state.currentMonth;
                }
            }
        }

        // æ¸²æŸ“æ—¥å†ç½‘æ ¼ï¼ˆä½¿ç”¨lunar.jsåŠŸèƒ½ï¼‰
        function renderCalendarGrid() {
            const grid = document.getElementById('calendarGrid');
            
            // æ›´æ–°æ˜ŸæœŸæ ‡é¢˜
            updateWeekdayHeaders(grid);

            // ä½¿ç”¨lunar.jsè·å–å½“æœˆä¿¡æ¯
            let firstDay, lastDay, firstWeekDay, daysInMonth;
            
            if (typeof Solar !== 'undefined') {
                try {
                    // ä½¿ç”¨Solar.fromYmdåˆ›å»ºå½“æœˆç¬¬ä¸€å¤©
                    firstDay = Solar.fromYmd(state.currentYear, state.currentMonth, 1);
                    // è·å–å½“æœˆå¤©æ•°
                    daysInMonth = SolarUtil.getDaysOfMonth(state.currentYear, state.currentMonth);
                    // è·å–å½“æœˆæœ€åä¸€å¤©
                    lastDay = Solar.fromYmd(state.currentYear, state.currentMonth, daysInMonth);
                    // è·å–ç¬¬ä¸€å¤©æ˜¯æ˜ŸæœŸå‡ 
                    firstWeekDay = firstDay.getWeek();
                } catch (error) {
                    console.warn('ä½¿ç”¨lunar.jsè·å–æœˆä»½ä¿¡æ¯å¤±è´¥ï¼Œä½¿ç”¨åŸç”Ÿæ–¹æ³•:', error);
                    // é™çº§åˆ°åŸç”Ÿæ–¹æ³•
                    firstDay = new Date(state.currentYear, state.currentMonth - 1, 1);
                    lastDay = new Date(state.currentYear, state.currentMonth, 0);
                    firstWeekDay = firstDay.getDay();
                    daysInMonth = lastDay.getDate();
                }
            } else {
                // å¦‚æœlunar.jsæœªåŠ è½½ï¼Œä½¿ç”¨åŸç”Ÿæ–¹æ³•
                firstDay = new Date(state.currentYear, state.currentMonth - 1, 1);
                lastDay = new Date(state.currentYear, state.currentMonth, 0);
                firstWeekDay = firstDay.getDay();
                daysInMonth = lastDay.getDate();
            }

            // è®¡ç®—éœ€è¦æ·»åŠ çš„ç©ºç™½æ—¥æœŸæ•°é‡
            let emptyDaysCount;
            if (state.weekStart === 0) {
                // å‘¨æ—¥å¼€å§‹
                emptyDaysCount = firstWeekDay;
            } else {
                // å‘¨ä¸€å¼€å§‹
                emptyDaysCount = firstWeekDay === 0 ? 6 : firstWeekDay - 1;
            }

            // æ·»åŠ ä¸Šä¸ªæœˆæœ«çš„æ—¥æœŸ
            const prevMonth = state.currentMonth === 1 ? 12 : state.currentMonth - 1;
            const prevMonthYear = state.currentMonth === 1 ? state.currentYear - 1 : state.currentYear;
            const prevMonthDays = SolarUtil ? SolarUtil.getDaysOfMonth(prevMonthYear, prevMonth) : new Date(prevMonthYear, prevMonth, 0).getDate();
            
            for (let i = emptyDaysCount - 1; i >= 0; i--) {
                const prevMonthDay = prevMonthDays - i;
                const dayElement = createCalendarDay(prevMonthDay, true); // trueè¡¨ç¤ºæ˜¯ä¸Šä¸ªæœˆ
                grid.appendChild(dayElement);
            }

            // æ·»åŠ å½“æœˆæ—¥æœŸ
            for (let day = 1; day <= daysInMonth; day++) {
                const dayElement = createCalendarDay(day);
                grid.appendChild(dayElement);
            }

            // æ·»åŠ ä¸‹ä¸ªæœˆåˆçš„æ—¥æœŸ
            const totalCells = 7 * 6; // 6è¡Œ7åˆ—
            const remainingCells = totalCells - (emptyDaysCount + daysInMonth);
            // ç¡®ä¿ä¸è¶…è¿‡å½“å‰å‘¨çš„æœ€åä¸€å¤©
            const daysToAdd = Math.min(remainingCells, 7 - ((emptyDaysCount + daysInMonth) % 7));
            for (let day = 1; day <= daysToAdd; day++) {
                const dayElement = createCalendarDay(day, false, true); // trueè¡¨ç¤ºæ˜¯ä¸‹ä¸ªæœˆ
                grid.appendChild(dayElement);
            }
        }

        // æ›´æ–°æ˜ŸæœŸæ ‡é¢˜
        function updateWeekdayHeaders(grid) {
            // æ¸…ç©ºç½‘æ ¼
            grid.innerHTML = '';
            
            let weekdayHeaders;
            if (state.weekStart === 0) {
                // å‘¨æ—¥å¼€å§‹ï¼šæ—¥ä¸€äºŒä¸‰å››äº”å…­
                weekdayHeaders = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
            } else {
                // å‘¨ä¸€å¼€å§‹ï¼šä¸€äºŒä¸‰å››äº”å…­æ—¥
                weekdayHeaders = ['ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­', 'æ—¥'];
            }
            
            // æ·»åŠ æ˜ŸæœŸæ ‡é¢˜
            weekdayHeaders.forEach(day => {
                const div = document.createElement('div');
                div.className = 'weekday';
                div.textContent = day;
                grid.appendChild(div);
            });
        }

        // åˆ›å»ºç©ºç™½æ—¥æœŸå…ƒç´ 
        function createEmptyDay() {
            const div = document.createElement('div');
            div.className = 'calendar-day other-month';
            return div;
        }



        // è®¡ç®—æ—¥æœŸä¿¡æ¯
        function calculateDateInfo(date) {
            try {
                // ä¼˜å…ˆä½¿ç”¨lunar.jså†…ç½®å‡½æ•°
                let solar;
                let totalWeeks = 52; // é»˜è®¤å€¼
                let totalDays = 365; // é»˜è®¤å€¼
                
                if (typeof Solar !== 'undefined') {
                    try {
                        solar = Solar.fromDate(date);
                        // è·å–ä¸€å¹´æ€»å¤©æ•°ï¼ˆè€ƒè™‘é—°å¹´ï¼‰
                        totalDays = SolarUtil.getDaysOfYear(solar.getYear());
                        // è®¡ç®—æ€»å‘¨æ•°ï¼ˆISOå‘¨æ ‡å‡†ï¼‰- ä½¿ç”¨åŸç”ŸJavaScriptå¤„ç†
                        const lastDateOfYear = new Date(solar.getYear(), 11, 31);
                        totalWeeks = getWeekNumber(lastDateOfYear);
                    } catch (error) {
                        console.warn('ä½¿ç”¨lunar.jsè®¡ç®—æ—¥æœŸä¿¡æ¯å¤±è´¥ï¼Œä½¿ç”¨åŸç”Ÿæ–¹æ³•:', error);
                    }
                }
                
                // ä½¿ç”¨åŸç”ŸJavaScriptè®¡ç®—æ—¥æœŸä¿¡æ¯
                const year = date.getFullYear();
                const startOfYear = new Date(year, 0, 1);
                const endOfYear = new Date(year, 11, 31);
                
                // è®¡ç®—ä¸€å¹´ä¸­çš„ç¬¬å‡ å¤©
                const dayOfYear = Math.floor((date - startOfYear) / (1000 * 60 * 60 * 24)) + 1;
                
                // è®¡ç®—ä¸€å¹´å‰©ä½™å¤©æ•°
                const daysRemaining = Math.floor((endOfYear - date) / (1000 * 60 * 60 * 24));
                
                // è®¡ç®—ä¸€å¹´ä¸­çš„ç¬¬å‡ å‘¨ï¼ˆISOå‘¨ï¼‰
                const weekOfYear = getWeekNumber(date);
                
                // è®¡ç®—ä¸€å¹´å‰©ä½™å‘¨æ•°ï¼ˆç¡®ä¿ä¸ä¸ºè´Ÿæ•°ï¼‰
                const lastWeekOfYear = getWeekNumber(endOfYear);
                const weeksRemaining = Math.max(0, lastWeekOfYear - weekOfYear);
                
                // æŸ¥æ‰¾ä¸‹ä¸€ä¸ªèŠ‚æ—¥
                let nextFestival = findNextFestival(date);
                
                return {
                    dayOfYear,
                    daysRemaining,
                    weekOfYear,
                    weeksRemaining,
                    totalWeeks,
                    totalDays,
                    nextFestival
                };
            } catch (error) {
                console.warn('è®¡ç®—æ—¥æœŸä¿¡æ¯å¤±è´¥:', error);
                return {
                    dayOfYear: 0,
                    daysRemaining: 0,
                    weekOfYear: 0,
                    weeksRemaining: 0,
                    nextFestival: 'æš‚æ— '
                };
            }
        }
        
        // è·å–ISOå‘¨æ•°
        function getWeekNumber(date) {
            const d = new Date(date);
            d.setHours(0, 0, 0, 0);
            
            // è·å–å½“å¹´çš„ç¬¬ä¸€ä¸ªå‘¨å››
            const jan1 = new Date(d.getFullYear(), 0, 1);
            const firstThursday = new Date(jan1);
            firstThursday.setDate(jan1.getDate() + (11 - jan1.getDay()) % 7);
            
            // è·å–æ—¥æœŸæ‰€åœ¨å‘¨çš„å‘¨å››
            const weekThursday = new Date(d);
            weekThursday.setDate(d.getDate() + (11 - d.getDay()) % 7);
            
            // è®¡ç®—å‘¨æ•°
            const diffTime = weekThursday - firstThursday;
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
            const weekNumber = Math.floor(diffDays / 7) + 1;
            
            // å¤„ç†è·¨å¹´æƒ…å†µ
            if (weekNumber === 0) {
                // å±äºä¸Šä¸€å¹´çš„æœ€åä¸€å‘¨
                return getWeekNumber(new Date(d.getFullYear() - 1, 11, 31));
            } else if (weekNumber === 53) {
                // æ£€æŸ¥æ˜¯å¦çœŸçš„æœ‰53å‘¨
                const dec31 = new Date(d.getFullYear(), 11, 31);
                const dec31Thursday = new Date(dec31);
                dec31Thursday.setDate(dec31.getDate() + (11 - dec31.getDay()) % 7);
                
                if (weekThursday.getTime() === dec31Thursday.getTime()) {
                    return 53;
                } else {
                    return 1; // å±äºä¸‹ä¸€å¹´ç¬¬ä¸€å‘¨
                }
            }
            
            return weekNumber;
        }
        
        // æŸ¥æ‰¾ä¸‹ä¸€ä¸ªèŠ‚æ—¥
        function findNextFestival(date) {
            if (typeof Solar === 'undefined') {
                return 'æš‚æ— ';
            }
            
            try {
                const solar = Solar.fromDate(date);
                
                // æŸ¥æ‰¾æœªæ¥30å¤©å†…çš„èŠ‚æ—¥
                for (let i = 1; i <= 30; i++) {
                    const futureSolar = solar.next(i);
                    const futureLunar = futureSolar.getLunar();
                    
                    const solarFestivals = futureSolar.getFestivals ? futureSolar.getFestivals() : [];
                    const lunarFestivals = futureLunar.getFestivals ? futureLunar.getFestivals() : [];
                    
                    if (solarFestivals.length > 0 || lunarFestivals.length > 0) {
                        const festival = solarFestivals[0] || lunarFestivals[0];
                        return `${festival} (${i}å¤©å)`;
                    }
                }
                
                return 'æš‚æ— ';
            } catch (error) {
                return 'æš‚æ— ';
            }
        }

        // æ˜¾ç¤ºæ—¥æœŸæç¤ºæ¡†
        function showDateTooltip(element, date) {
            const tooltip = document.getElementById('dateTooltip');
            if (!tooltip) {
                console.log('æœªæ‰¾åˆ°å¼¹æ¡†å…ƒç´ ');
                return;
            }
            
            // æ·»åŠ æ˜¾ç¤ºç±»
            tooltip.classList.add('show');
            
            if (typeof Solar === 'undefined') {
                console.log('lunar.js æœªåŠ è½½');
                return;
            }
            
            try {
                const solar = Solar.fromDate(date);
                const lunar = solar.getLunar ? solar.getLunar() : null;
                
                if (!lunar) return;
                
                // ä½¿ç”¨å›ºå®šå³ä¸‹è§’ä½ç½®ï¼Œç§»é™¤åŠ¨æ€ä½ç½®è®¡ç®—
                // å¼¹æ¡†ç°åœ¨å›ºå®šåœ¨å³ä¸‹è§’ï¼Œä¸éœ€è¦åŠ¨æ€ä½ç½®è®¡ç®—
                tooltip.style.left = '';
                tooltip.style.top = '';
                
                // æ›´æ–°å†…å®¹
                // å…¬å†æ—¥æœŸ
                const weekDays = ['æ˜ŸæœŸæ—¥', 'æ˜ŸæœŸä¸€', 'æ˜ŸæœŸäºŒ', 'æ˜ŸæœŸä¸‰', 'æ˜ŸæœŸå››', 'æ˜ŸæœŸäº”', 'æ˜ŸæœŸå…­'];
                const weekDay = weekDays[date.getDay()];
                document.getElementById('tooltipSolarDate').textContent = 
                    `${solar.getYear()}å¹´${solar.getMonth()}æœˆ${solar.getDay()}æ—¥ ${weekDay}`;
                
                // å†œå†æ—¥æœŸ - æ ¼å¼ï¼šä¹™å·³è›‡å¹´ å†¬æœˆï¼ˆåæœˆï¼‰åˆä¹
                let lunarText = '';
                
                // è·å–å¹´ä»½å¹²æ”¯å’Œç”Ÿè‚–
                const yearGanZhi = lunar.getYearInGanZhi ? lunar.getYearInGanZhi() : '';
                const yearShengXiao = lunar.getYearShengXiao ? lunar.getYearShengXiao() : '';
                
                // è·å–æœˆä»½
                const monthInChinese = lunar.getMonthInChinese ? lunar.getMonthInChinese() : '';
                
                // è·å–å¤©æ•°
                const dayInChinese = lunar.getDayInChinese ? lunar.getDayInChinese() : '';
                
                // æ„å»ºå†œå†æ˜¾ç¤ºæ ¼å¼
                if (yearGanZhi && yearShengXiao) {
                    lunarText = `${yearGanZhi}${yearShengXiao}å¹´ `;
                }
                
                if (monthInChinese) {
                    lunarText += monthInChinese + 'æœˆ';
                }
                
                if (dayInChinese) {
                    lunarText += dayInChinese;
                }
                
                document.getElementById('tooltipLunarDate').textContent = lunarText;
                
                // æ˜¾ç¤ºæ—¥æœŸè®¡ç®—ä¿¡æ¯
                const dateInfo = calculateDateInfo(date);
                const dateInfoElement = document.getElementById('tooltipDateInfo');
                if (dateInfo) {
                    dateInfoElement.style.display = 'block';
                    document.getElementById('tooltipWeekOfYear').textContent = dateInfo.weekOfYear;
                    document.getElementById('tooltipWeeksRemaining').textContent = dateInfo.weeksRemaining;
                    document.getElementById('tooltipTotalWeeks').textContent = dateInfo.totalWeeks;
                    document.getElementById('tooltipDayOfYear').textContent = dateInfo.dayOfYear;
                    document.getElementById('tooltipDaysRemaining').textContent = dateInfo.daysRemaining;
                    document.getElementById('tooltipTotalDays').textContent = dateInfo.totalDays;
                    document.getElementById('tooltipNextFestival').textContent = dateInfo.nextFestival;
                } else {
                    dateInfoElement.style.display = 'none';
                }
                
                // æ£€æŸ¥èŠ‚æ°”
                const jieqi = lunar.getJieQi ? lunar.getJieQi() : null;
                const jieqiElement = document.getElementById('tooltipJieqi');
                if (jieqi && jieqiDesc[jieqi] && state.festivalSettings.showJieqi) {
                    jieqiElement.style.display = 'flex';
                    document.getElementById('tooltipJieqiName').textContent = jieqi;
                    document.getElementById('tooltipJieqiDesc').textContent = jieqiDesc[jieqi];
                    
                    // è®¾ç½®èŠ‚æ°”å›¾ç‰‡
                    const imgElement = document.getElementById('tooltipJieqiImg');
                    const jieqiImagePath = getJieqiImagePath(jieqi);
                    if (jieqiImagePath) {
                        imgElement.src = jieqiImagePath;
                        imgElement.alt = jieqi;
                    } else {
                        // å¦‚æœå›¾ç‰‡ä¸å­˜åœ¨ï¼Œä½¿ç”¨é»˜è®¤å›¾ç‰‡
                        imgElement.src = '';
                    }
                } else {
                    jieqiElement.style.display = 'none';
                }
                
                // æ£€æŸ¥ä¸‰ä¼ã€ä¸‰ä¹
                const fuJiuElement = document.getElementById('tooltipFuJiu');
                let hasFuJiu = false;
                let fuText = '';
                let jiuText = '';
                
                // æ£€æŸ¥ä¸‰ä¼
                if (lunar.getFu) {
                    const fu = lunar.getFu();
                    if (fu) {
                        hasFuJiu = true;
                        fuText = fu;
                    }
                }
                
                // æ£€æŸ¥ä¸‰ä¹ï¼ˆä½¿ç”¨æ–°çš„getShuJiuæ–¹æ³•ï¼‰
                if (lunar.getShuJiu) {
                    const shuJiu = lunar.getShuJiu();
                    if (shuJiu) {
                        hasFuJiu = true;
                        jiuText = shuJiu.getName() + 'ç¬¬' + shuJiu.getIndex() + 'å¤©';
                    }
                }
                
                // å…¼å®¹æ—§çš„ä¸‰ä¹æ–¹æ³•
                if (lunar.getJiu) {
                    const jiu = lunar.getJiu();
                    if (jiu) {
                        hasFuJiu = true;
                        jiuText = jiu;
                    }
                }
                
                // åªæœ‰å½“æœ‰èŠ‚æ°”è®¾ç½®ä¸”ç¡®å®æœ‰ä¸‰ä¼ä¸‰ä¹ä¿¡æ¯æ—¶æ‰æ˜¾ç¤º
                if (state.festivalSettings.showJieqi && hasFuJiu) {
                    fuJiuElement.style.display = 'block';
                    
                    // è®¾ç½®ä¸‰ä¼ä¿¡æ¯ï¼Œå¦‚æœæ²¡æœ‰ä¸‰ä¼åˆ™æ¸…ç©º
                    document.getElementById('tooltipFu').textContent = fuText || '';
                    document.getElementById('tooltipJiu').textContent = jiuText || '';
                    
                    // å¦‚æœå…¶ä¸­ä¸€ä¸ªæ²¡æœ‰å†…å®¹ï¼Œéšè—å¯¹åº”çš„div
                    const tooltipFu = document.getElementById('tooltipFu');
                    const tooltipJiu = document.getElementById('tooltipJiu');
                    
                    if (!fuText) {
                        tooltipFu.style.display = 'none';
                    } else {
                        tooltipFu.style.display = 'block';
                    }
                    
                    if (!jiuText) {
                        tooltipJiu.style.display = 'none';
                    } else {
                        tooltipJiu.style.display = 'block';
                    }
                    
                    // å¦‚æœä¸¤è€…éƒ½æ²¡æœ‰å†…å®¹ï¼Œéšè—æ•´ä¸ªä¼ ç»ŸèŠ‚æ°”éƒ¨åˆ†
                    if (!fuText && !jiuText) {
                        fuJiuElement.style.display = 'none';
                    }
                } else {
                    fuJiuElement.style.display = 'none';
                }
                
                // æ£€æŸ¥èŠ‚å‡æ—¥
                const holidayElement = document.getElementById('tooltipHoliday');
                if (typeof HolidayUtil !== 'undefined') {
                    const holidayInfo = HolidayUtil.getHoliday(solar.getYear(), solar.getMonth(), solar.getDay());
                    if (holidayInfo) {
                        holidayElement.style.display = 'block';
                        holidayElement.className = `tooltip-holiday ${holidayInfo.isWork() ? 'work' : 'rest'}`;
                        document.getElementById('tooltipHolidaySymbol').textContent = holidayInfo.isWork() ? 'ç­' : 'ä¼‘';
                        document.getElementById('tooltipHolidayName').textContent = holidayInfo.getName();
                    } else {
                        holidayElement.style.display = 'none';
                    }
                } else {
                    holidayElement.style.display = 'none';
                }
                
                // æ£€æŸ¥èŠ‚æ—¥
                const festivalsElement = document.getElementById('tooltipFestivals');
                const festivalListElement = document.getElementById('tooltipFestivalList');
                festivalListElement.innerHTML = '';
                
                let allFestivals = [];
                
                // æ ¹æ®è®¾ç½®è·å–ç›¸åº”ç±»å‹çš„èŠ‚æ—¥
                if (state.festivalSettings.showSolarFestivals) {
                    const solarFestivals = solar.getFestivals ? solar.getFestivals() : [];
                    allFestivals = allFestivals.concat(solarFestivals);
                }
                
                if (state.festivalSettings.showLunarFestivals) {
                    const lunarFestivals = lunar.getFestivals ? lunar.getFestivals() : [];
                    allFestivals = allFestivals.concat(lunarFestivals);
                }
                
                if (state.festivalSettings.showOtherFestivals) {
                    const otherFestivals = lunar.getOtherFestivals ? lunar.getOtherFestivals() : [];
                    allFestivals = allFestivals.concat(otherFestivals);
                }
                
                // è·å–æ˜ŸæœŸèŠ‚æ—¥
                if (state.festivalSettings.showWeekFestivals && typeof SolarUtil !== 'undefined' && SolarUtil.WEEK_FESTIVAL) {
                    const week = solar.getWeek();
                    const weekInMonth = Math.ceil(solar.getDay() / 7);
                    const weekKey1 = solar.getMonth() + '-' + weekInMonth + '-' + week;
                    const weekKey2 = solar.getMonth() + '-0-' + week;
                    
                    const addedFestivals = new Set(allFestivals);
                    
                    if (SolarUtil.WEEK_FESTIVAL[weekKey1]) {
                        const festival = SolarUtil.WEEK_FESTIVAL[weekKey1];
                        if (!addedFestivals.has(festival)) {
                            allFestivals.push(festival);
                        }
                    }
                    if (SolarUtil.WEEK_FESTIVAL[weekKey2]) {
                        const festival = SolarUtil.WEEK_FESTIVAL[weekKey2];
                        if (!addedFestivals.has(festival)) {
                            allFestivals.push(festival);
                        }
                    }
                }
                
                // æ˜¾ç¤ºèŠ‚æ—¥åˆ—è¡¨
                if (allFestivals.length > 0) {
                    festivalsElement.style.display = 'block';
                    allFestivals.forEach(festival => {
                        const festivalItem = document.createElement('div');
                        festivalItem.className = 'tooltip-festival-item';
                        festivalItem.textContent = festival;
                        festivalListElement.appendChild(festivalItem);
                    });
                } else {
                    festivalsElement.style.display = 'none';
                }
                
                // æ˜¾ç¤ºæç¤ºæ¡†
                tooltip.classList.add('show');
                
            } catch (error) {
                console.warn('æ˜¾ç¤ºæ—¥æœŸæç¤ºæ¡†å¤±è´¥:', error);
            }
        }

        // éšè—æ—¥æœŸæç¤ºæ¡†
        function hideDateTooltip() {
            const tooltip = document.getElementById('dateTooltip');
            if (tooltip) {
                tooltip.classList.remove('show');
            }
        }

        // åˆ›å»ºæ—¥å†æ—¥æœŸå…ƒç´ 
        function createCalendarDay(day, isPrevMonth = false, isNextMonth = false) {
            const div = document.createElement('div');
            
            // è®¾ç½®æ—¥æœŸç±»å
            if (isPrevMonth || isNextMonth) {
                div.className = 'calendar-day other-month';
            } else {
                div.className = 'calendar-day';
            }

            // è®¡ç®—å®é™…æ—¥æœŸ
            let date;
            if (isPrevMonth) {
                // ä¸Šä¸ªæœˆæœ«çš„æ—¥æœŸ
                date = new Date(state.currentYear, state.currentMonth - 2, day);
            } else if (isNextMonth) {
                // ä¸‹ä¸ªæœˆåˆçš„æ—¥æœŸ
                date = new Date(state.currentYear, state.currentMonth, day);
            } else {
                // å½“å‰æœˆçš„æ—¥æœŸ
                date = new Date(state.currentYear, state.currentMonth - 1, day);
            }
            
            // æ·»åŠ æ—¥æœŸæ ‡è¯†å±æ€§
            div.setAttribute('data-date', date.toDateString());
            
            div.onclick = () => selectDate(date);

            // æ·»åŠ é¼ æ ‡æ‚¬åœäº‹ä»¶
            let hoverTimer;
            div.addEventListener('mouseenter', () => {
                hoverTimer = setTimeout(() => {
                    showDateTooltip(div, date);
                }, 500); // 0.5ç§’åæ˜¾ç¤ºæç¤ºæ¡†
            });
            
            div.addEventListener('mouseleave', () => {
                clearTimeout(hoverTimer);
                hideDateTooltip();
            });
            
            // åˆ¤æ–­æ˜¯å¦ä¸ºå‘¨æœ«
            const dayOfWeek = date.getDay();
            if ((state.weekStart === 0 && (dayOfWeek === 0 || dayOfWeek === 6)) || // å‘¨æ—¥å¼€å§‹ï¼šå‘¨æ—¥=0ï¼Œå‘¨å…­=6
                (state.weekStart === 1 && (dayOfWeek === 6 || dayOfWeek === 0))) { // å‘¨ä¸€å¼€å§‹ï¼šå‘¨å…­=6ï¼Œå‘¨æ—¥=0
                div.classList.add('weekend');
            }
            
            // æ—¥æœŸæ•°å­—
            const dayNumber = document.createElement('div');
            dayNumber.className = 'day-number';
            dayNumber.textContent = day;
            
            // å¦‚æœæ˜¯éå½“å‰æœˆçš„æ—¥æœŸï¼Œæ·»åŠ é€æ˜åº¦æ•ˆæœ
            if (isPrevMonth || isNextMonth) {
                dayNumber.style.opacity = '0.5';
            }
            
            div.appendChild(dayNumber);

            // å¦‚æœlunar.jsæœªåŠ è½½ï¼Œåªæ˜¾ç¤ºå…¬å†æ—¥æœŸ
            if (typeof Solar === 'undefined') {
                return div;
            }
            
            try {
                const solar = Solar.fromDate(date);
                const lunar = solar.getLunar ? solar.getLunar() : null;

                if (lunar) {
                    // å†œå†æ—¥æœŸ
                    const lunarDay = document.createElement('div');
                    lunarDay.className = 'lunar-day';
                    
                    // å¦‚æœæ˜¯éå½“å‰æœˆçš„æ—¥æœŸï¼Œå†œå†æ—¥æœŸä¹Ÿæ·»åŠ é€æ˜åº¦
                    if (isPrevMonth || isNextMonth) {
                        lunarDay.style.opacity = '0.5';
                    }
                    
                    lunarDay.textContent = lunar.getDayInChinese ? lunar.getDayInChinese() : '';
                    div.appendChild(lunarDay);

                    // æ£€æŸ¥èŠ‚æ—¥
                    checkAndAddFestival(div, solar, lunar);
                }
            } catch (error) {
                console.warn('è·å–å†œå†ä¿¡æ¯å¤±è´¥:', error);
            }

            // æ£€æŸ¥æ˜¯å¦ä»Šå¤©
            const today = new Date();
            if (date.toDateString() === today.toDateString()) {
                div.classList.add('today');
            }

            // æ£€æŸ¥é€‰ä¸­çŠ¶æ€
            if (state.selectedDate && 
                date.toDateString() === state.selectedDate.toDateString()) {
                div.classList.add('selected');
            }

            return div;
        }



        // æ£€æŸ¥å¹¶æ·»åŠ èŠ‚æ—¥æ ‡è®°
        function checkAndAddFestival(div, solar, lunar) {
            let hasTag = false;

            // æ£€æŸ¥èŠ‚æ°”
            const jieqi = lunar.getJieQi ? lunar.getJieQi() : null;
            // æ£€æŸ¥èŠ‚æ°”æ˜¯å¦æœ‰æ•ˆï¼ˆä¸ä¸ºç©ºä¸”ä¸æ˜¯null/undefinedï¼‰
            if (jieqi && jieqi.trim() !== '' && state.festivalSettings.showJieqi) {
                const tag = document.createElement('div');
                tag.className = 'jieqi-tag';
                // getJieQi() ç›´æ¥è¿”å›èŠ‚æ°”åç§°å­—ç¬¦ä¸²
                tag.textContent = jieqi;
                tag.title = jieqi; // é¼ æ ‡æ‚¬åœæ˜¾ç¤ºå®Œæ•´èŠ‚æ°”åç§°
                tag.style.background = jieqiData[jieqi] || '#4ECDC4';
                div.appendChild(tag);
                hasTag = true;
            }

            // æ£€æŸ¥ä¸‰ä¼ã€ä¸‰ä¹ç­‰ç‰¹æ®ŠèŠ‚æ°”
            if (state.festivalSettings.showJieqi) {
                // æ£€æŸ¥ä¸‰ä¼
                if (lunar.getFu) {
                    const fu = lunar.getFu();
                    if (fu) {
                        const fuTag = document.createElement('div');
                        fuTag.className = 'fu-jiu-tag';
                        fuTag.textContent = fu;
                        fuTag.title = fu;
                        div.appendChild(fuTag);
                        hasTag = true;
                    }
                }
                
                // æ£€æŸ¥ä¸‰ä¹ï¼ˆä½¿ç”¨æ–°çš„getShuJiuæ–¹æ³•ï¼‰
                if (lunar.getShuJiu) {
                    const shuJiu = lunar.getShuJiu();
                    if (shuJiu) {
                        const jiuTag = document.createElement('div');
                        jiuTag.className = 'fu-jiu-tag';
                        jiuTag.textContent = shuJiu.getName();
                        jiuTag.title = shuJiu.getName() + 'ç¬¬' + shuJiu.getIndex() + 'å¤©';
                        div.appendChild(jiuTag);
                        hasTag = true;
                    }
                }
                
                // å…¼å®¹æ—§çš„ä¸‰ä¹æ–¹æ³•
                if (lunar.getJiu) {
                    const jiu = lunar.getJiu();
                    if (jiu) {
                        const jiuTag = document.createElement('div');
                        jiuTag.className = 'fu-jiu-tag';
                        jiuTag.textContent = jiu;
                        jiuTag.title = jiu;
                        div.appendChild(jiuTag);
                        hasTag = true;
                    }
                }
                
                // ç§»é™¤äº†æ‰‹åŠ¨è®¡ç®—éƒ¨åˆ†ï¼Œåªæœ‰å½“lunar.jsè¿”å›çœŸå®çš„ä¸‰ä¹ä¿¡æ¯æ—¶æ‰æ˜¾ç¤ºæ ‡ç­¾
            }

            // æ£€æŸ¥èŠ‚å‡æ—¥
            let holidayInfo = null;
            if (typeof HolidayUtil !== 'undefined') {
                holidayInfo = HolidayUtil.getHoliday(solar.getYear(), solar.getMonth(), solar.getDay());
            }
            
            // æ£€æŸ¥æ™®é€šèŠ‚æ—¥
            const solarFestivals = solar.getFestivals ? solar.getFestivals() : [];
            const lunarFestivals = lunar.getFestivals ? lunar.getFestivals() : [];
            const otherFestivals = lunar.getOtherFestivals ? lunar.getOtherFestivals() : [];
            
            // è·å–æ˜ŸæœŸèŠ‚æ—¥
            let weekFestivals = [];
            if (typeof SolarUtil !== 'undefined' && SolarUtil.WEEK_FESTIVAL && state.festivalSettings.showWeekFestivals) {
                const week = solar.getWeek();
                const weekInMonth = Math.ceil(solar.getDay() / 7);
                const weekKey1 = solar.getMonth() + '-' + weekInMonth + '-' + week;
                const weekKey2 = solar.getMonth() + '-0-' + week;
                
                // ä½¿ç”¨Setæ¥é¿å…é‡å¤æ·»åŠ åŒä¸€ä¸ªèŠ‚æ—¥
                const addedFestivals = new Set();
                
                if (SolarUtil.WEEK_FESTIVAL[weekKey1]) {
                    const festival = SolarUtil.WEEK_FESTIVAL[weekKey1];
                    if (!addedFestivals.has(festival)) {
                        weekFestivals.push(festival);
                        addedFestivals.add(festival);
                    }
                }
                if (SolarUtil.WEEK_FESTIVAL[weekKey2]) {
                    const festival = SolarUtil.WEEK_FESTIVAL[weekKey2];
                    if (!addedFestivals.has(festival)) {
                        weekFestivals.push(festival);
                        addedFestivals.add(festival);
                    }
                }
            }
            
            let festivals = [];
            
            // ä½¿ç”¨Setæ¥é¿å…æ‰€æœ‰ç±»å‹çš„é‡å¤èŠ‚æ—¥
            const addedFestivals = new Set();
            
            // æ ¹æ®è®¾ç½®ç­›é€‰èŠ‚æ—¥ç±»å‹
            if (state.festivalSettings.showSolarFestivals) {
                solarFestivals.forEach(festival => {
                    if (!addedFestivals.has(festival)) {
                        festivals.push(festival);
                        addedFestivals.add(festival);
                    }
                });
            }
            if (state.festivalSettings.showLunarFestivals) {
                lunarFestivals.forEach(festival => {
                    if (!addedFestivals.has(festival)) {
                        festivals.push(festival);
                        addedFestivals.add(festival);
                    }
                });
            }
            if (state.festivalSettings.showOtherFestivals) {
                otherFestivals.forEach(festival => {
                    if (!addedFestivals.has(festival)) {
                        festivals.push(festival);
                        addedFestivals.add(festival);
                    }
                });
            }
            // æ˜ŸæœŸèŠ‚æ—¥å·²ç»å¤„ç†è¿‡é‡å¤ï¼Œä½†è¿™é‡Œä¹Ÿè¦æ£€æŸ¥
            weekFestivals.forEach(festival => {
                if (!addedFestivals.has(festival)) {
                    festivals.push(festival);
                    addedFestivals.add(festival);
                }
            });
            
            // å¦‚æœæœ‰èŠ‚å‡æ—¥ï¼Œåœ¨å³ä¸Šè§’æ˜¾ç¤º"ä¼‘"æˆ–"ç­"
            if (holidayInfo) {
                const holidayTag = document.createElement('div');
                holidayTag.className = 'holiday-tag';
                
                // ç®€åŒ–æ˜¾ç¤ºï¼šä¼‘æ¯æ—¥æ˜¾ç¤º"ä¼‘"ï¼Œè°ƒä¼‘æ—¥æ˜¾ç¤º"ç­"
                if (holidayInfo.isWork()) {
                    holidayTag.textContent = 'ç­';
                    holidayTag.style.background = '#E6A23C'; // è°ƒä¼‘æ—¥ - æ©™è‰²
                } else {
                    holidayTag.textContent = 'ä¼‘';
                    holidayTag.style.background = '#5CB85C'; // ä¼‘æ¯æ—¥ - ç»¿è‰²
                }
                
                // æ·»åŠ èŠ‚å‡æ—¥åç§°ä½œä¸ºæç¤º
                holidayTag.title = holidayInfo.getName();
                
                div.appendChild(holidayTag);
                hasTag = true;
            }
            
            // å¦‚æœæœ‰æ™®é€šèŠ‚æ—¥ï¼Œåœ¨é¡¶éƒ¨ä¸­é—´æ˜¾ç¤ºèŠ‚æ—¥åç§°
            if (festivals.length > 0) {
                // è·å–æ‰€æœ‰èŠ‚æ—¥åç§°ç”¨äºtooltip
                const allFestivalNames = festivals.join('ã€');
                
                // ä¸ºæ¯ä¸ªèŠ‚æ—¥åˆ›å»ºå•ç‹¬çš„æ ‡ç­¾
                festivals.forEach((festivalName, index) => {
                    const festivalTag = document.createElement('div');
                    festivalTag.className = 'festival-tag';
                    
                    // æ˜¾ç¤ºç¬¬ä¸€ä¸ªèŠ‚æ—¥æ ‡ç­¾åœ¨é¡¶éƒ¨ï¼Œå…¶ä»–çš„ç¨å¾®åç§»
                    if (index === 0) {
                        festivalTag.style.top = '2px';
                    } else {
                        festivalTag.style.top = (2 + index * 12) + 'px';
                    }
                    
                    // ç®€åŒ–æ˜¾ç¤ºåç§°
                    let displayName = festivalName;
                    if (festivalName.length > 3) {
                        // ç®€åŒ–èŠ‚æ—¥åç§°æ˜¾ç¤º
                        if (festivalName.includes('èŠ‚')) {
                            displayName = festivalName.replace('èŠ‚', '');
                        }
                        if (displayName.length > 3) {
                            displayName = displayName.substring(0, 3);
                        }
                    }
                    
                    festivalTag.textContent = displayName;
                    festivalTag.title = festivalName; // é¼ æ ‡æ‚¬åœæ˜¾ç¤ºå®Œæ•´åç§°
                    festivalTag.style.background = '#FF6B6B'; // æ™®é€šèŠ‚æ—¥ - çº¢è‰²
                    
                    div.appendChild(festivalTag);
                    hasTag = true;
                });
                
                // å¦‚æœæœ‰å¤šä¸ªèŠ‚æ—¥ï¼Œæ·»åŠ ä¸€ä¸ªæ˜¾ç¤ºå…¨éƒ¨çš„tooltip
                if (festivals.length > 1) {
                    div.title = allFestivalNames;
                }
            }

            return hasTag;
        }



        // é€‰æ‹©æ—¥æœŸ
        function selectDate(date) {
            state.selectedDate = date;

            // æ›´æ–°é€‰ä¸­çŠ¶æ€
            document.querySelectorAll('.calendar-day').forEach(el => {
                el.classList.remove('selected');
            });

            // å¦‚æœç‚¹å‡»çš„æ˜¯éå½“å‰æœˆçš„æ—¥æœŸï¼Œéœ€è¦åˆ‡æ¢åˆ°ç›¸åº”æœˆä»½
            const clickedYear = date.getFullYear();
            const clickedMonth = date.getMonth() + 1;

            if (clickedYear !== state.currentYear || clickedMonth !== state.currentMonth) {
                state.currentYear = clickedYear;
                state.currentMonth = clickedMonth;

                // é‡æ–°æ¸²æŸ“æ—¥å†
                renderCalendar();

                // å»¶è¿Ÿé€‰ä¸­æ—¥æœŸï¼Œç¡®ä¿æ—¥å†å·²ç»æ¸²æŸ“å®Œæˆ
                setTimeout(() => {
                    document.querySelectorAll('.calendar-day').forEach(el => {
                        if (el.getAttribute('data-date') === date.toDateString()) {
                            el.classList.add('selected');
                        }
                    });
                    // æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯
                    showDetail(date);
                }, 100);
            } else {
                // å½“å‰æœˆçš„æ—¥æœŸï¼Œç›´æ¥é€‰ä¸­
                event.target.classList.add('selected');
                // æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯
                showDetail(date);
            }

            // å¤åˆ¶è¯¦æƒ…å†…å®¹åˆ°å‰ªè´´æ¿
            copyDetailToClipboard(date);
        }

        // å¤åˆ¶é»„å†è¯¦æƒ…åˆ°å‰ªè´´æ¿
        function copyDetailToClipboard(date) {
            if (typeof Solar === 'undefined') return;

            try {
                const solar = Solar.fromDate(date);
                const lunar = solar.getLunar ? solar.getLunar() : null;

                if (!lunar) return;

                // å¹²æ”¯ä¿¡æ¯
                const yearGanZhi = lunar.getYearInGanZhi();
                const monthGanZhi = lunar.getMonthInGanZhi();
                const dayGanZhi = lunar.getDayInGanZhi();
                const yearShengXiao = lunar.getYearShengXiao();

                // è·å–æ˜ŸæœŸ
                const weekDays = ['æ˜ŸæœŸæ—¥', 'æ˜ŸæœŸä¸€', 'æ˜ŸæœŸäºŒ', 'æ˜ŸæœŸä¸‰', 'æ˜ŸæœŸå››', 'æ˜ŸæœŸäº”', 'æ˜ŸæœŸå…­'];
                const weekDay = weekDays[solar.getWeek()];

                // è·å–å®œå¿Œä¿¡æ¯
                const yi = lunar.getDayYi ? lunar.getDayYi() : [];
                const ji = lunar.getDayJi ? lunar.getDayJi() : [];

                // è·å–çº³éŸ³äº”è¡Œ
                const nayin = lunar.getDayNaYin ? lunar.getDayNaYin() : 'è·å–ä¸­';

                // è·å–å†²ç…
                const xiongsha = lunar.getDayXiongSha ? lunar.getDayXiongSha() : null;
                const chongsha = (xiongsha && xiongsha.length > 0) ? xiongsha.join(' ') : 'å†²ç…ä¿¡æ¯è·å–ä¸­';

                // è·å–å½­ç¥–ç™¾å¿Œ
                const pengzuGan = lunar.getPengZuGan ? lunar.getPengZuGan() : '';
                const pengzuZhi = lunar.getPengZuZhi ? lunar.getPengZuZhi() : '';
                const pengzu = (pengzuGan && pengzuZhi) ? pengzuGan + ' ' + pengzuZhi : 'å½­ç¥–ç™¾å¿Œè·å–ä¸­';

                // è·å–ç¥ç…
                const jishen = lunar.getDayJiShen ? lunar.getDayJiShen() : [];
                const xiongshen = lunar.getDayXiongSha ? lunar.getDayXiongSha() : [];

                // è·å–æ–¹ä½
                const xishenDesc = lunar.getDayPositionXiDesc ? lunar.getDayPositionXiDesc() : '';
                const fushenDesc = lunar.getDayPositionFuDesc ? lunar.getDayPositionFuDesc() : '';
                const caishenDesc = lunar.getDayPositionCaiDesc ? lunar.getDayPositionCaiDesc() : '';

                // è·å–èŠ‚æ—¥ä¿¡æ¯
                const festivalInfo = getFestivalInfo(date);
                let festivalText = '';
                if (festivalInfo && festivalInfo.solarFestivals && festivalInfo.lunarFestivals) {
                    if (festivalInfo.solarFestivals.length > 0 || festivalInfo.lunarFestivals.length > 0) {
                        const allFestivals = [...festivalInfo.solarFestivals, ...festivalInfo.lunarFestivals];
                        festivalText = '\nã€èŠ‚æ—¥ã€‘' + allFestivals.join('ã€');
                    }
                }

                // èŠ‚æ°”
                const jieqi = solar.getJieQi ? solar.getJieQi() : null;
                let jieqiText = '';
                if (jieqi) {
                    jieqiText = '\nã€èŠ‚æ°”ã€‘' + jieqi;
                }

                // æ ¼å¼åŒ–é˜³å†æ—¥æœŸ
                const solarYear = date.getFullYear();
                const solarMonth = date.getMonth() + 1;
                const solarDay = date.getDate();
                const solarDateStr = `${solarYear}å¹´${solarMonth}æœˆ${solarDay}æ—¥`;

                // ç»„è£…æ–‡æœ¬å†…å®¹
                const textToCopy = `ã€æ—¥æœŸã€‘${solarDateStr} ${weekDay}
ã€å†œå†ã€‘${lunar.getYearInGanZhi()}${yearShengXiao}å¹´ ${lunar.getMonthInChinese()}æœˆ${lunar.getDayInChinese()}æ—¥
ã€å¹²æ”¯ã€‘${yearGanZhi}${monthGanZhi}${dayGanZhi}
ã€äº”è¡Œã€‘${nayin}
ã€å†²ç…ã€‘${chongsha}
ã€å½­ç¥–ã€‘${pengzu}
ã€å–œç¥ã€‘${xishenDesc || 'æ— '}
ã€ç¦ç¥ã€‘${fushenDesc || 'æ— '}
ã€è´¢ç¥ã€‘${caishenDesc || 'æ— '}
ã€å®œã€‘${yi.join(' ')}
ã€å¿Œã€‘${ji.join(' ')}
ã€å‰ç¥ã€‘${jishen.join(' ') || 'æ— '}
ã€å‡¶ç¥ã€‘${xiongshen.join(' ') || 'æ— '}${festivalText}${jieqiText}`;

                // å¤åˆ¶åˆ°å‰ªè´´æ¿
                navigator.clipboard.writeText(textToCopy).then(() => {
                    showToast('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
                }).catch(err => {
                    console.error('å¤åˆ¶å¤±è´¥:', err);
                    // é™çº§æ–¹æ¡ˆ
                    const textarea = document.createElement('textarea');
                    textarea.value = textToCopy;
                    document.body.appendChild(textarea);
                    textarea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textarea);
                    showToast('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
                });
            } catch (error) {
                console.error('å¤åˆ¶è¯¦æƒ…æ—¶å‡ºé”™:', error);
            }
        }

        // æ˜¾ç¤ºæç¤ºä¿¡æ¯
        function showToast(message) {
            // ç§»é™¤æ—§çš„æç¤º
            const oldToast = document.querySelector('.toast-message');
            if (oldToast) {
                oldToast.remove();
            }

            // åˆ›å»ºæ–°æç¤º
            const toast = document.createElement('div');
            toast.className = 'toast-message';
            toast.textContent = message;
            document.body.appendChild(toast);

            // 2ç§’åç§»é™¤
            setTimeout(() => {
                toast.remove();
            }, 2000);
        }

        // è·å–èŠ‚æ°”è¯¦ç»†ä¿¡æ¯
        function getJieqiDetail(date) {
            if (typeof Solar === 'undefined') return null;
            
            try {
                const solar = Solar.fromDate(date);
                const lunar = solar.getLunar ? solar.getLunar() : null;
                
                if (!lunar) return null;
                
                const currentJieqi = lunar.getJieQi ? lunar.getJieQi() : null;
                
                // è·å–å½“å‰èŠ‚æ°”çŠ¶æ€
                const isTodayJieqi = currentJieqi !== null && currentJieqi !== '';
                
                // è®¡ç®—è·ç¦»ä¸‹ä¸ªèŠ‚æ°”çš„å¤©æ•°
                let daysToNextJieqi = null;
                let nextJieqiName = null;
                
                // æŸ¥æ‰¾ä¸‹ä¸ªèŠ‚æ°”
                let checkDate = new Date(date);
                for (let i = 1; i <= 45; i++) { // æœ€å¤šå¾€åæŸ¥æ‰¾45å¤©
                    checkDate.setDate(checkDate.getDate() + 1);
                    const checkSolar = Solar.fromDate(checkDate);
                    const checkLunar = checkSolar.getLunar ? checkSolar.getLunar() : null;
                    if (checkLunar) {
                        const checkJieqi = checkLunar.getJieQi ? checkLunar.getJieQi() : null;
                        if (checkJieqi) {
                            nextJieqiName = checkJieqi;
                            daysToNextJieqi = i;
                            break;
                        }
                    }
                }
                
                return {
                    currentJieqi: currentJieqi || '',
                    nextJieqi: nextJieqiName,
                    daysToNextJieqi,
                    isTodayJieqi
                };
            } catch (error) {
                console.error('è·å–èŠ‚æ°”è¯¦ç»†ä¿¡æ¯å¤±è´¥:', error);
                return null;
            }
        }

        // è·å–å³å°†åˆ°æ¥çš„èŠ‚æ—¥é¢„å‘Š
        function getUpcomingFestivals(date) {
            if (typeof Solar === 'undefined') return [];
            
            const upcomingFestivals = [];
            let checkDate = new Date(date);
            
            // æŸ¥æ‰¾æœªæ¥365å¤©å†…çš„èŠ‚æ—¥
            for (let i = 1; i <= 365; i++) {
                checkDate.setDate(checkDate.getDate() + 1);
                
                try {
                    const checkSolar = Solar.fromDate(checkDate);
                    const checkLunar = checkSolar.getLunar ? checkSolar.getLunar() : null;
                    
                    if (checkLunar) {
                        let allFestivals = [];
                        
                        // æ ¹æ®è®¾ç½®è·å–ç›¸åº”ç±»å‹çš„èŠ‚æ—¥
                        if (state.festivalSettings.showSolarFestivals) {
                            const solarFestivals = checkSolar.getFestivals ? checkSolar.getFestivals() : [];
                            allFestivals = allFestivals.concat(solarFestivals);
                        }
                        
                        if (state.festivalSettings.showLunarFestivals) {
                            const lunarFestivals = checkLunar.getFestivals ? checkLunar.getFestivals() : [];
                            allFestivals = allFestivals.concat(lunarFestivals);
                        }
                        
                        if (state.festivalSettings.showOtherFestivals) {
                            const otherFestivals = checkLunar.getOtherFestivals ? checkLunar.getOtherFestivals() : [];
                            allFestivals = allFestivals.concat(otherFestivals);
                        }
                        
                        // è·å–æ˜ŸæœŸèŠ‚æ—¥
                        if (state.festivalSettings.showWeekFestivals && typeof SolarUtil !== 'undefined' && SolarUtil.WEEK_FESTIVAL) {
                            const week = checkSolar.getWeek();
                            const weekInMonth = Math.ceil(checkSolar.getDay() / 7);
                            const weekKey1 = checkSolar.getMonth() + '-' + weekInMonth + '-' + week;
                            const weekKey2 = checkSolar.getMonth() + '-0-' + week;
                            
                            // ä½¿ç”¨Setæ¥é¿å…é‡å¤æ·»åŠ åŒä¸€ä¸ªèŠ‚æ—¥
                            const addedFestivals = new Set(allFestivals);
                            
                            if (SolarUtil.WEEK_FESTIVAL[weekKey1]) {
                                const festival = SolarUtil.WEEK_FESTIVAL[weekKey1];
                                if (!addedFestivals.has(festival)) {
                                    allFestivals.push(festival);
                                    addedFestivals.add(festival);
                                }
                            }
                            if (SolarUtil.WEEK_FESTIVAL[weekKey2]) {
                                const festival = SolarUtil.WEEK_FESTIVAL[weekKey2];
                                if (!addedFestivals.has(festival)) {
                                    allFestivals.push(festival);
                                    addedFestivals.add(festival);
                                }
                            }
                        }
                        
                        // è·å–èŠ‚æ°”
                        if (state.festivalSettings.showJieqi) {
                            const jieqi = checkLunar.getJieQi ? checkLunar.getJieQi() : null;
                            if (jieqi) {
                                allFestivals.push(jieqi);
                            }
                        }
                        
                        // å¦‚æœæœ‰èŠ‚æ—¥æˆ–èŠ‚æ°”
                        if (allFestivals.length > 0) {
                            for (const festival of allFestivals) {
                                // é¿å…é‡å¤æ·»åŠ åŒä¸€å¤©çš„èŠ‚æ—¥
                                const exists = upcomingFestivals.some(f => 
                                    f.name === festival && f.days === i
                                );
                                if (!exists) {
                                    upcomingFestivals.push({
                                        name: festival,
                                        days: i,
                                        date: new Date(checkDate)
                                    });
                                }
                            }
                        }
                    }
                } catch (error) {
                    console.warn('è·å–èŠ‚æ—¥ä¿¡æ¯å¤±è´¥:', error);
                }
                
                // å¦‚æœå·²ç»æ‰¾åˆ°è¶³å¤Ÿçš„èŠ‚æ—¥å°±åœæ­¢æœç´¢
                if (upcomingFestivals.length >= 10) break;
            }
            
            // æŒ‰å¤©æ•°æ’åºï¼Œå–å‰3ä¸ª
            return upcomingFestivals
                .sort((a, b) => a.days - b.days)
                .slice(0, 3);
        }

        // è·å–èŠ‚æ—¥ä¿¡æ¯
        function getFestivalInfo(date) {
            if (typeof Solar === 'undefined') return { jieqi: [], holidays: [] };
            
            try {
                const solar = Solar.fromDate(date);
                const lunar = solar.getLunar ? solar.getLunar() : null;
                
                if (!lunar) return { jieqi: [], holidays: [] };
                
                const jieqi = lunar.getJieQi ? lunar.getJieQi() : null;
                const solarFestivals = solar.getFestivals ? solar.getFestivals() : [];
                const lunarFestivals = lunar.getFestivals ? lunar.getFestivals() : [];
                
                // getJieQi() ç›´æ¥è¿”å›èŠ‚æ°”åç§°å­—ç¬¦ä¸²
                return {
                    jieqi: jieqi ? [jieqi] : [],
                    holidays: [...solarFestivals, ...lunarFestivals]
                };
            } catch (error) {
                return { jieqi: [], holidays: [] };
            }
        }

        // æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯
        function showDetail(date) {
            if (typeof Solar === 'undefined') {
                console.error('lunar.js æœªåŠ è½½');
                return;
            }
            
            try {
                const solar = Solar.fromDate(date);
                const lunar = solar.getLunar ? solar.getLunar() : null;
                
                if (!lunar) {
                    console.error('æ— æ³•è·å–å†œå†ä¿¡æ¯');
                    return;
                }

            const detailPanel = document.getElementById('detailPanel');
            
            // å¹²æ”¯ä¿¡æ¯
            const yearGanZhi = lunar.getYearInGanZhi();
            const monthGanZhi = lunar.getMonthInGanZhi();
            const dayGanZhi = lunar.getDayInGanZhi();
            const yearShengXiao = lunar.getYearShengXiao();

            // è·å–æ˜ŸæœŸ
            const weekDays = ['æ˜ŸæœŸæ—¥', 'æ˜ŸæœŸä¸€', 'æ˜ŸæœŸäºŒ', 'æ˜ŸæœŸä¸‰', 'æ˜ŸæœŸå››', 'æ˜ŸæœŸäº”', 'æ˜ŸæœŸå…­'];
            const weekDay = weekDays[solar.getWeek()];

            // è·å–å®œå¿Œä¿¡æ¯
            const yi = lunar.getDayYi();
            const ji = lunar.getDayJi();

            // è·å–çº³éŸ³äº”è¡Œ
            const nayin = lunar.getDayNaYin ? lunar.getDayNaYin() : 'è·å–ä¸­';

            // è·å–å†²ç…
            const xiongsha = lunar.getDayXiongSha ? lunar.getDayXiongSha() : [];
            const chongsha = xiongsha.length > 0 ? xiongsha.join(' ') : 'å†²ç…ä¿¡æ¯è·å–ä¸­';

            // è·å–å½­ç¥–ç™¾å¿Œ
            const pengzuGan = lunar.getPengZuGan ? lunar.getPengZuGan() : '';
            const pengzuZhi = lunar.getPengZuZhi ? lunar.getPengZuZhi() : '';
            const pengzu = (pengzuGan && pengzuZhi) ? pengzuGan + ' ' + pengzuZhi : 'å½­ç¥–ç™¾å¿Œè·å–ä¸­';

            // è·å–ç¥ç…
            const jishen = lunar.getDayJiShen ? lunar.getDayJiShen() : [];
            const xiongshen = lunar.getDayXiongSha ? lunar.getDayXiongSha() : [];

            // è·å–æ–¹ä½
            const xishen = lunar.getDayPositionXi ? lunar.getDayPositionXi() : null;
            const xishenDesc = xishen && lunar.getDayPositionXiDesc ? lunar.getDayPositionXiDesc() : '';
            const fushen = lunar.getDayPositionFu ? lunar.getDayPositionFu() : null;
            const fushenDesc = fushen && lunar.getDayPositionFuDesc ? lunar.getDayPositionFuDesc() : '';
            const caishen = lunar.getDayPositionCai ? lunar.getDayPositionCai() : null;
            const caishenDesc = caishen && lunar.getDayPositionCaiDesc ? lunar.getDayPositionCaiDesc() : '';



            // è·å–èŠ‚æ—¥ä¿¡æ¯
            const festivalInfo = getFestivalInfo(date);
            
            // è·å–èŠ‚å‡æ—¥ä¿¡æ¯
            let holidayInfo = null;
            let holidayHTML = '';
            if (typeof HolidayUtil !== 'undefined') {
                holidayInfo = HolidayUtil.getHoliday(solar.getYear(), solar.getMonth(), solar.getDay());
                if (holidayInfo) {
                    const isWorkDay = holidayInfo.isWork();
                    const statusText = isWorkDay ? 'è°ƒä¼‘ä¸Šç­' : 'æ³•å®šä¼‘æ¯';
                    const statusIcon = isWorkDay ? 'ğŸ¢' : 'ğŸ–ï¸';
                    const statusSymbol = isWorkDay ? 'ç­' : 'ä¼‘';
                    
                    holidayHTML = `
                        <div class="holiday-section">
                            <div class="holiday-title">å…¬ä¼‘å®‰æ’</div>
                            <div class="holiday-status ${isWorkDay ? 'work' : 'rest'}">
                                <span class="holiday-symbol">${statusSymbol}</span>
                                <span class="holiday-icon">${statusIcon}</span>
                                <span class="holiday-name">${holidayInfo.getName()}</span>
                                <span class="holiday-type">${statusText}</span>
                            </div>
                        </div>
                    `;
                }
            }
            

            
            // è·å–å³å°†åˆ°æ¥çš„èŠ‚æ—¥é¢„å‘Š
            const upcomingFestivals = getUpcomingFestivals(date);
            let upcomingHTML = '';
            if (upcomingFestivals.length > 0) {
                upcomingHTML = `
                    <div class="upcoming-section">
                        <div class="upcoming-title">é¢„å‘Š</div>
                        <div class="upcoming-list">
                            ${upcomingFestivals.map(festival => `
                                <div class="upcoming-item">
                                    <div class="upcoming-name">${festival.name}</div>
                                    <div class="upcoming-days">è¿˜æœ‰${festival.days}å¤©</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            // æ ¼å¼åŒ–é˜³å†æ—¥æœŸ
            const solarYear = date.getFullYear();
            const solarMonth = date.getMonth() + 1;
            const solarDay = date.getDate();
            const solarDateStr = `${solarYear}å¹´${solarMonth}æœˆ${solarDay}æ—¥`;
            
            detailPanel.innerHTML = `
                <div class="huangli">
                    <div class="solar-date">${solarDateStr}</div>
                    <div id="md">å†œå†${lunar.getMonthInChinese()}æœˆ${lunar.getDayInChinese()}</div>
                    <div id="ymd">
                        <i>${yearGanZhi}${yearShengXiao}å¹´</i>
                        <i>${monthGanZhi}æœˆ</i>
                        <i>${dayGanZhi}æ—¥</i>
                        <i>${weekDay}</i>
                    </div>
                    <div class="nayin"><b>äº”è¡Œ</b><i id="nayin">${nayin}</i></div>
                    <div class="chongsha"><b>å†²ç…</b><i id="chongsha">${chongsha}</i></div>
                    <div class="pengzu"><b>å½­ç¥–</b><i id="pengzu">${pengzu}</i></div>
                    <div class="fangwei-container">
                        <div class="fangwei-item">
                            <b>å–œç¥</b>
                            <i id="xishen">${xishenDesc || 'è·å–ä¸­'}</i>
                        </div>
                        <div class="fangwei-item">
                            <b>ç¦ç¥</b>
                            <i id="fushen">${fushenDesc || 'è·å–ä¸­'}</i>
                        </div>
                        <div class="fangwei-item">
                            <b>è´¢ç¥</b>
                            <i id="caishen">${caishenDesc || 'è·å–ä¸­'}</i>
                        </div>
                    </div>
                    <div class="yishen-container">
                        <div class="yiji" id="yi">
                            <b>å®œ</b>
                            <div class="yiji-content">
                                ${yi.map(item => `<i>${item}</i>`).join('')}
                            </div>
                        </div>
                        <div class="yiji ji" id="ji">
                            <b>å¿Œ</b>
                            <div class="yiji-content">
                                ${ji.map(item => `<i>${item}</i>`).join('')}
                            </div>
                        </div>
                        <div class="shen" id="jshen">
                            <b>å‰ç¥</b>
                            <div class="shen-content">
                                ${jishen.map(item => `<i>${item}</i>`).join('')}
                            </div>
                        </div>
                        <div class="shen" id="xshen">
                            <b>å‡¶ç¥</b>
                            <div class="shen-content">
                                ${xiongshen.map(item => `<i>${item}</i>`).join('')}
                            </div>
                        </div>
                    </div>
                    ${holidayHTML}
                    ${upcomingHTML}
                </div>
            `;

            // æ·»åŠ åŠ¨ç”»æ•ˆæœ
            detailPanel.style.animation = 'none';
            setTimeout(() => {
                detailPanel.style.animation = 'slideIn 0.3s ease-out';
            }, 10);
            } catch (error) {
                console.error('æ˜¾ç¤ºé»„å†ä¿¡æ¯æ—¶å‡ºé”™:', error);
                detailPanel.innerHTML = '<div class="empty-state"><p>åŠ è½½é»„å†ä¿¡æ¯å¤±è´¥</p></div>';
            }
        }

        // åˆ‡æ¢æœˆä»½
        function changeMonth(direction) {
            state.currentMonth += direction;
            
            if (state.currentMonth > 12) {
                state.currentMonth = 1;
                state.currentYear++;
            } else if (state.currentMonth < 1) {
                state.currentMonth = 12;
                state.currentYear--;
            }
            
            renderCalendar();
        }

        // è·³è½¬åˆ°ä»Šå¤©
        function goToToday() {
            const today = new Date();
            state.currentYear = today.getFullYear();
            state.currentMonth = today.getMonth() + 1;
            
            renderCalendar();
            // å»¶è¿Ÿé€‰ä¸­ä»Šå¤©ï¼Œç¡®ä¿æ—¥å†å·²ç»æ¸²æŸ“å®Œæˆ
            setTimeout(() => {
                showToday();
            }, 100);
        }

        // æ·»åŠ CSSåŠ¨ç”»
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from {
                    opacity: 0;
                    transform: translateY(20px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }
        `;
        document.head.appendChild(style);

        // åˆå§‹åŒ–å‘¨èµ·å§‹æ—¥è®¾ç½®
        function initializeWeekStartSettings() {
            // ä»localStorageåŠ è½½è®¾ç½®
            const savedWeekStart = localStorage.getItem('weekStart');
            if (savedWeekStart) {
                try {
                    state.weekStart = parseInt(savedWeekStart);
                    updateWeekStartUI();
                } catch (error) {
                    console.warn('åŠ è½½å‘¨èµ·å§‹æ—¥è®¾ç½®å¤±è´¥:', error);
                }
            } else {
                // é»˜è®¤å‘¨ä¸€ä¸ºæ¿€æ´»çŠ¶æ€
                state.weekStart = 1;
                updateWeekStartUI();
            }
        }

        // åˆ‡æ¢å‘¨èµ·å§‹æ—¥
        function toggleWeekStart(value) {
            state.weekStart = value;
            
            // ä¿å­˜è®¾ç½®åˆ°localStorage
            localStorage.setItem('weekStart', state.weekStart.toString());
            
            // æ›´æ–°UI
            updateWeekStartUI();
            
            // é‡æ–°æ¸²æŸ“æ—¥å†
            renderCalendar();
        }

        // æ›´æ–°å‘¨èµ·å§‹æ—¥UIçŠ¶æ€
        function updateWeekStartUI() {
            const options = document.querySelectorAll('.weekstart-option');
            options.forEach(option => {
                const value = parseInt(option.getAttribute('data-value'));
                if (value === state.weekStart) {
                    option.classList.add('active');
                } else {
                    option.classList.remove('active');
                }
            });
        }

        // åˆå§‹åŒ–èŠ‚æ—¥è®¾ç½®
        function initializeFestivalSettings() {
            // ä»localStorageåŠ è½½è®¾ç½®
            const savedSettings = localStorage.getItem('festivalSettings');
            if (savedSettings) {
                try {
                    const settings = JSON.parse(savedSettings);
                    Object.assign(state.festivalSettings, settings);
                    
                    // æ›´æ–°checkboxçŠ¶æ€
                    Object.keys(settings).forEach(key => {
                        const checkbox = document.getElementById(key);
                        if (checkbox) {
                            checkbox.checked = settings[key];
                        }
                    });
                } catch (error) {
                    console.warn('åŠ è½½èŠ‚æ—¥è®¾ç½®å¤±è´¥:', error);
                }
            }
        }

        // åˆ‡æ¢èŠ‚æ—¥é€‰æ‹©å™¨æ˜¾ç¤º
        function toggleFestivalSelector() {
            const dropdown = document.getElementById('festivalDropdown');
            if (dropdown) {
                dropdown.classList.toggle('show');
                
                // ç‚¹å‡»å…¶ä»–åœ°æ–¹å…³é—­ä¸‹æ‹‰èœå•
                document.addEventListener('click', closeFestivalSelector);
            }
        }

        // å…³é—­èŠ‚æ—¥é€‰æ‹©å™¨
        function closeFestivalSelector(event) {
            const dropdown = document.getElementById('festivalDropdown');
            const toggle = document.querySelector('.festival-toggle');
            
            if (dropdown && !dropdown.contains(event.target) && event.target !== toggle) {
                dropdown.classList.remove('show');
                document.removeEventListener('click', closeFestivalSelector);
            }
        }

        // æ›´æ–°èŠ‚æ—¥è®¾ç½®
        function updateFestivalSettings() {
            const checkboxes = ['showSolarFestivals', 'showLunarFestivals', 'showJieqi', 'showWeekFestivals', 'showOtherFestivals'];
            
            checkboxes.forEach(id => {
                const checkbox = document.getElementById(id);
                if (checkbox) {
                    state.festivalSettings[id] = checkbox.checked;
                }
            });
            
            // ä¿å­˜è®¾ç½®åˆ°localStorage
            localStorage.setItem('festivalSettings', JSON.stringify(state.festivalSettings));
            
            // é‡æ–°æ¸²æŸ“æ—¥å†
            renderCalendar();
        }



        // æµ‹è¯•å‡½æ•°ï¼šæ˜¾ç¤ºå½“å‰æœˆä»½æ‰€æœ‰åŒ…å«ä¸‰ä¹ä¿¡æ¯çš„æ—¥æœŸ
        function showFuJiuDates() {
            if (typeof Solar === 'undefined') {
                alert('lunar.js æœªåŠ è½½å®Œæˆ');
                return;
            }
            
            const daysInMonth = SolarUtil.getDaysOfMonth(state.currentYear, state.currentMonth);
            let fuJiuDates = [];
            
            for (let day = 1; day <= daysInMonth; day++) {
                try {
                    const solar = Solar.fromYmd(state.currentYear, state.currentMonth, day);
                    const lunar = solar.getLunar();
                    
                    // æ£€æŸ¥ä¸‰ä¼
                    if (lunar.getFu) {
                        const fu = lunar.getFu();
                        if (fu) {
                            fuJiuDates.push(`${state.currentYear}å¹´${state.currentMonth}æœˆ${day}æ—¥ - ${fu}`);
                        }
                    }
                    
                    // æ£€æŸ¥ä¸‰ä¹ï¼ˆä½¿ç”¨æ–°çš„getShuJiuæ–¹æ³•ï¼‰
                    if (lunar.getShuJiu) {
                        const shuJiu = lunar.getShuJiu();
                        if (shuJiu) {
                            fuJiuDates.push(`${state.currentYear}å¹´${state.currentMonth}æœˆ${day}æ—¥ - ${shuJiu.getName()}ç¬¬${shuJiu.getIndex()}å¤©`);
                        }
                    }
                    
                    // å…¼å®¹æ—§çš„ä¸‰ä¹æ–¹æ³•
                    if (lunar.getJiu) {
                        const jiu = lunar.getJiu();
                        if (jiu) {
                            fuJiuDates.push(`${state.currentYear}å¹´${state.currentMonth}æœˆ${day}æ—¥ - ${jiu}`);
                        }
                    }
                } catch (error) {
                    console.warn(`è·å–${state.currentYear}å¹´${state.currentMonth}æœˆ${day}æ—¥ä¿¡æ¯å¤±è´¥:`, error);
                }
            }
            
            if (fuJiuDates.length > 0) {
                alert('å½“å‰æœˆä»½åŒ…å«ä¸‰ä¹ä¿¡æ¯çš„æ—¥æœŸï¼š\n\n' + fuJiuDates.join('\n'));
            } else {
                // æ™ºèƒ½æç¤ºï¼šæ ¹æ®å½“å‰æœˆä»½ç»™å‡ºå»ºè®®
                let suggestion = '';
                if (state.currentMonth >= 3 && state.currentMonth <= 8) {
                    suggestion = '\n\næç¤ºï¼šä¸‰ä¹ä¿¡æ¯é€šå¸¸åœ¨å†¬å­£ï¼ˆ12æœˆ-2æœˆï¼‰å‡ºç°ã€‚\nå»ºè®®åˆ‡æ¢åˆ°å†¬å­£æœˆä»½æŸ¥çœ‹ä¸‰ä¹ä¿¡æ¯ã€‚';
                } else if (state.currentMonth >= 6 && state.currentMonth <= 8) {
                    suggestion = '\n\næç¤ºï¼šå½“å‰æ˜¯å¤å­£ï¼Œä¸‰ä¼ä¿¡æ¯é€šå¸¸åœ¨å¤å­£å‡ºç°ã€‚\nå»ºè®®æŸ¥çœ‹ä¸‰ä¼ä¿¡æ¯æˆ–åˆ‡æ¢åˆ°å†¬å­£æŸ¥çœ‹ä¸‰ä¹ä¿¡æ¯ã€‚';
                } else {
                    suggestion = '\n\næç¤ºï¼šä¸‰ä¹ä¿¡æ¯é€šå¸¸åœ¨å†¬è‡³åå¼€å§‹å‡ºç°ã€‚\nå»ºè®®æ£€æŸ¥å½“å‰å¹´ä»½çš„å†¬è‡³æ—¥æœŸæ˜¯å¦æ­£ç¡®ã€‚';
                }
                
                // æ£€æŸ¥å†¬è‡³æ˜¯å¦åœ¨å½“å‰æœˆä»½
                try {
                    const dongzhi = Lunar.fromYmd(state.currentYear, 12, 1).getJieQiTable()['å†¬è‡³'];
                    if (dongzhi) {
                        // å°è¯•ä¸åŒçš„è·å–æ–¹å¼
                        let dongzhiDate, dongzhiMonth;
                        if (typeof dongzhi.getSolar === 'function') {
                            dongzhiDate = dongzhi.getSolar();
                            dongzhiMonth = dongzhiDate.getMonth();
                        } else if (dongzhi.getMonth) {
                            dongzhiMonth = dongzhi.getMonth();
                            dongzhiDate = dongzhi;
                        } else {
                            // å¦‚æœæ— æ³•è·å–æœˆä»½ä¿¡æ¯ï¼Œç›´æ¥æ˜¾ç¤ºæ—¥æœŸ
                            dongzhiDate = dongzhi.toString ? dongzhi.toString() : dongzhi;
                            suggestion += `\n\nå†¬è‡³æ—¥æœŸï¼š${dongzhiDate}ï¼Œæ•°ä¹ä»è¿™ä¸€å¤©å¼€å§‹ã€‚`;
                            return;
                        }
                        
                        if (dongzhiMonth + 1 === state.currentMonth) {
                            suggestion += `\n\nå†¬è‡³æ—¥æœŸï¼š${dongzhiDate.toString()}ï¼Œæ•°ä¹ä»è¿™ä¸€å¤©å¼€å§‹ã€‚`;
                        }
                    }
                } catch (error) {
                    console.warn('è·å–å†¬è‡³ä¿¡æ¯å¤±è´¥:', error);
                }
                
                alert('å½“å‰æœˆä»½æ²¡æœ‰ä¸‰ä¹ä¿¡æ¯' + suggestion);
            }
        }

        // åˆ‡æ¢ä¸»é¢˜é€‰æ‹©å™¨æ˜¾ç¤º
        function toggleThemeSelector() {
            const dropdown = document.getElementById('themeDropdown');
            if (dropdown) {
                dropdown.classList.toggle('show');
                
                // ç‚¹å‡»å…¶ä»–åœ°æ–¹å…³é—­ä¸‹æ‹‰èœå•
                document.addEventListener('click', closeThemeSelector);
            }
        }

        // å…³é—­ä¸»é¢˜é€‰æ‹©å™¨
        function closeThemeSelector(event) {
            const dropdown = document.getElementById('themeDropdown');
            const toggle = document.querySelector('.theme-toggle');
            
            if (dropdown && !dropdown.contains(event.target) && event.target !== toggle) {
                dropdown.classList.remove('show');
                document.removeEventListener('click', closeThemeSelector);
            }
        }

        // è®¾ç½®ä¸»é¢˜
        function setTheme(theme) {
            // ç§»é™¤æ‰€æœ‰ä¸»é¢˜ç±»
            document.body.classList.remove('light-theme', 'dark-theme');
            
            if (theme === 'dark') {
                document.body.classList.add('dark-theme');
            } else if (theme === 'light') {
                // æµ…è‰²ä¸»é¢˜ä¸éœ€è¦é¢å¤–ç±»å
            } else if (theme === 'system') {
                // æ£€æµ‹ç³»ç»Ÿä¸»é¢˜åå¥½
                if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    document.body.classList.add('dark-theme');
                }
            }
            
            // ä¿å­˜ä¸»é¢˜è®¾ç½®åˆ°localStorage
            localStorage.setItem('theme', theme);
            
            // æ›´æ–°UIçŠ¶æ€
            updateThemeUI(theme);
            
            // å…³é—­ä¸‹æ‹‰èœå•
            const dropdown = document.getElementById('themeDropdown');
            if (dropdown) {
                dropdown.classList.remove('show');
            }
        }

        // æ›´æ–°ä¸»é¢˜UIçŠ¶æ€
        function updateThemeUI(activeTheme) {
            const options = document.querySelectorAll('.theme-option');
            options.forEach(option => {
                const theme = option.getAttribute('data-theme');
                if (theme === activeTheme) {
                    option.classList.add('active');
                } else {
                    option.classList.remove('active');
                }
            });
        }

        // åˆå§‹åŒ–ä¸»é¢˜è®¾ç½®
        function initializeThemeSettings() {
            // ä»localStorageåŠ è½½è®¾ç½®ï¼Œé»˜è®¤ä½¿ç”¨"è·Ÿéšç³»ç»Ÿ"
            const savedTheme = localStorage.getItem('theme');
            const theme = savedTheme || 'system';
            setTheme(theme);
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>